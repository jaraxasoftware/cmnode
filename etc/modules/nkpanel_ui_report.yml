version: 1.0
type: module
category: ui
name: nkpanel_ui_report
spec:
  init:
    model:
      selected_scenario: ""
      selected_failure_tab: "Failure"
      report_id: ""
      report:
        query: ""
        scenarios: []
  decoders:
    show_report:
      object:
        effect: "ui"
        event:
          object:
            show_report:
              any: text
    unselect_report_scenario:
      object:
        effect: ui
        event:
          object:
            name: "toggle-report-scenario"
            scenario:
              text:
                key: selected_scenario
    select_report_scenario:
      object:
        effect: ui
        event:
          object:
            name: "toggle-report-scenario"
            scenario:
              text:
                other_than: 
                  key: selected_scenario
    select_failure_tab:
      object:
        effect: ui
        event:
          object:
            name: "select-failure-tab"
            tab:
              any: text
    report:
      object:
        effect: "ws"
        data:
          object:
            test_report:
              object:
                id:
                  any: text
                timestamp:
                  any: number
                query:
                  any: text
                seconds:
                  any: number
                status:
                  any: text
                scenarios:
                  object:
                    fail: 
                      any: number
                    success:
                      any: number
                    total:
                      any: number
                result:
                  one_of:
                    - list:
                        size: 0
                    - list:
                        one_of:
                          - object:
                            elapsed:
                              any: number
                              scenario:
                                any: text
                                status: "success"
                          - object:
                            elapsed:
                              any: number
                              scenario:
                                any: text
                                status: "fail"
                                failure:
                                  object:
                                    reason: 
                                    any: object
                                    step:
                                      any: object
                                      world:
                                        any: object
  update:
    show_report:
      model:
        report_id:
          key: show_report
          in: event
      cmds:
        - effect: ws
          encoder: test_report_query
        - effect: ui
          encoder: report_view
    select_report_scenario:
      model:
        selected_scenario:
          key: scenario
          in: event
      cmds:
        - effect: ui
    unselect_report_scenario:
      model:
        selected_scenario: ""
      cmds:
        - effect: ui
    select_failure_tab:
      model:
        selected_failure_tab:
          key: tab
          in: event
      cmds:
        - effect: ui
    report:
      model:
        report:
          key: test_report
          in: data
      cmds:
        - effect: ui

  encoders:
    test_report_query:
      object:
        action: "test_report"
        report:
          key: report_id
    scenario_status_badge:
      view:
        view: status-label
        params:
          object:
            style:
              either:
                - when: 
                    eq:
                      - key: status
                      - text: "success"
                  text: "success"
                - when: 
                    eq:
                      - key: status
                      - text: "error"
                  text: "danger"
                - text: "warning"
            title:
              either:
                - when: 
                    eq:
                      - key: status
                      - text: "success"
                  text: "Pass"
                - when: 
                    eq:
                      - key: status
                      - text: "error"
                  text: "Error"
                - text: "Fail"
    
    tab_header:
      view:
        tag: div
        attrs:
          class: 
            format:
              pattern: "tab-header ~a"
              params:
                - either:
                    - when:
                        eq:
                          - key: selected
                            in: context
                          - key: title
                            in: item
                      text: "active"
                    - text: ""
          onclick:
            key: onclick
            in: item
        children:
          - text:
              key: title
              in: item
    tab_body:
      view:
        tag: div
        children:
          - view:
              key: view
              in: item
            when:
              eq:
                - key: title
                  in: item
                - key: selected
                  in: context
            params:
              object:
                content:
                  key: content
                  in: item
    tabbed:
      view:
        tag: div
        attrs:
          class: "tabbed"
        children:
          - tag: div
            attrs:
              class: "header"
            children:
              loop: tabs
              with: tab_header
              context:
                object:
                  selected:
                    key: selected
          - tag: div
            attrs:
              class: "body"
            children:
              loop: tabs
              with: tab_body
              context:
                object:
                  selected:
                    key: selected
    report_scenario_failure:
      view:
        view: tabbed
        params:
          object:
            selected:
              key: tab
            tabs: 
              list:
                - object:
                    title: "Failure"
                    onclick:
                      object:
                        name: "select-failure-tab"
                        tab: "Failure"
                    view: json_view
                    content:
                      key: reason
                      in: 
                        key: failure
                        in: result
                - object:
                    title: "Step"
                    onclick:
                      object:
                        name: "select-failure-tab"
                        tab: "Step"
                    view: json_view
                    content:
                      key: step
                      in: 
                        key: failure
                        in: result
                - object:
                    title: "World"
                    onclick:
                      object:
                        name: "select-failure-tab"
                        tab: "World"
                    view: json_view
                    content:
                      key: world
                      in: 
                        key: failure
                        in: result
    report_scenario_success:
      view:
        tag: div
        children:
          - text: "No failures to show"
    report_scenario_detail:
      view:
        tag: div
        attrs:
          class: "collapsable"
        children:
          - view: 
              either:
                - when: 
                    not:
                      eq:
                        - text: "success"
                        - key: status
                          in: result
                  text: "report_scenario_failure"
                - text: "report_scenario_success"
            when:
              eq:
                - key: selected
                - key: scenario
                  in: result
            params:
              object:
                tab:
                  key: tab
                result:
                  key: result

    report_scenario_toggle_switch:
      view:
        tag: span
        attrs:
          class: "toggle mx-2"
          onclick:
            object:
              name: "toggle-report-scenario"
              scenario:
                key: scenario
        children:
          - tag: i
            attrs:
              class:
                either:
                  - when:
                      eq:
                        - key: scenario
                        - key: selected
                    text: "fas fa-chevron-circle-up"
                  - text: "fas fa-chevron-circle-down"
    report_scenario_table_item:
      view:
        tag: div
        attrs:
          object:
            class: "row"
            key: 
              key: scenario
              in: item
        children:
          - tag: div
            attrs:
              class: "status"
            children:
              - view: scenario_status_badge
                params:
                  object:
                    status:
                      key: status
                      in: item
          - tag: div
            attrs: 
              class: "content with-status"
            children:
              - tag: div
                attrs:
                  class: "info"
                children:
                  - text:
                      format:
                        pattern: "~a ms"
                        params:
                          - key: elapsed
                            in: item
                  - view: report_scenario_toggle_switch
                    params:
                      object:
                        scenario:
                          key: scenario
                          in: item
                        selected:
                          key: selected
                          in: context
              - tag: h6
                children:
                  - text:
                      key: scenario
                      in: item
              - view: report_scenario_detail
                params:
                  object:
                    tab:
                      key: failure_tab
                      in: context
                    selected:
                      key: selected
                      in: context
                    result:
                      key: item
    report_stats_view:
      view:
        tag: p
        children:
          - text:
              format:
                pattern: "~a/~a scenarios, ~a seconds"
                params:
                  - key: success
                    in:
                      key: scenarios
                  - key: total 
                    in:
                      key: scenarios
                  - key: seconds
    report_scenarios_table:
      view:
        tag: div
        attrs:
          class: "table"
        children:
          - tag: div
            attrs:
              class: "title"
            children:
              - tag: div
                attrs:
                  class: "actions"
                children:
                  - view: button
                    params:
                      object:
                        style: "btn-sm primary"
                        title: "Run this test again"
                        onclick:
                          object:
                            name: "run-test"
                            test: 
                              key: test
              - tag: h6 
                children:
                  - text: "Scenarios"
              - tag: span 
                children:
                  - text: "Summary of scenarios run by this test"
          - tag: div
            attrs:
              class: "body"
            children:
              loop:
                key: items
              with: report_scenario_table_item
              context:
                object:
                  failure_tab:
                    key: selected_failure_tab
                  selected:
                    key: selected_scenario
    report_scenarios_view:
      view:
        tag: div
        attrs:
          class: "column col-8"
        children:
          - view: panel
            params:
              object:
                style: "filled"
                view: report_scenarios_table
                content:
                  object:
                    selected_failure_tab:
                      key: selected_failure_tab
                    selected_scenario:
                      key: selected_scenario
                    test:
                      key: query
                      in: report
                    items:
                      key: result 
                      in: report
    report_status_prop:
      view:
        view: report_status_badge
        params:
          key: content
    report_stats_prop:
      view:
        view: report_stats_view
        params:
          key: content
    report_summary_info:
      view:
        tag: div
        attrs:
          class: "summary"
        children:
          - view: props
            params:
              object:
                title:
                  key: query
                  in: report
                props:
                  list:
                    - object:
                        title: "Ran"
                        view: timestamp_view
                        content:
                          key: timestamp
                          in: report
                    - object:
                        title: "Summary"
                        view: report_status_prop
                        content:
                          key: scenarios
                          in: report
                    - object:
                        title: "Pass rate"
                        view: report_stats_prop
                        content:
                          key: report
    report_summary_view:
      view:
        tag: div
        attrs:
          class: "column col-4"
        children:
          - view: panel
            params:
              object:
                style: "report"
                view: report_summary_info
                content:
                  object:
                    report:
                      key: report
    report_dashboard:
      view:
        view: main
        params:
          object:
            title: "Report"
            subtitle: 
              format: 
                pattern: "Test results for ~a"
                params:
                  - key: query
                    in: report
            icon: "fas fa-flag-checkered"
            views:
              list:
                - object:
                    name: report_summary_view
                    content:
                      object:
                        report:
                          key: report
                - object:
                    name: report_scenarios_view
                    content:
                      object:
                        selected_failure_tab:
                          key: selected_failure_tab
                        selected_scenario:
                          key: selected_scenario
                        report:
                          key: report
    report_view:
      view:
        view: nkpanel_view
        params:
          object:
            prefs:
              key: prefs
            inspector:
              object:
                status:
                  key: inspector
                content:
                  encoder: inspector_content 
            feature:
              object:
                name: "test"
                view: "report_dashboard"
                content:
                  object:
                    selected_scenario:
                      key: selected_scenario
                    selected_failure_tab:
                      key: selected_failure_tab
                    report:
                      key: report
