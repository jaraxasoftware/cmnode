version: 1.0
type: module
category: ui
name: nkpanel_ui_backups
spec:
  init:
    model:
      backups: []
      backups_activity:
        object:
          active:
            object:
              items: []
              max: 10
              current: 0
          pending:
            object:
              items: []
              max: 10
              current: 0
  decoders:
    show_backups:
      object:
        effect: ui
        event: "show_backups"
    backups:
      object:
        effect: ws
        data:
          object:
            backups:
              list:
                object:
                  env:
                    any: text
                  backup:
                    any: text
                  database:
                    any: text
                  elapsed:
                    any: number
                  kind:
                    any: text
                  status:
                    any: text
                  started:
                    any: text
    backup_selected:
      object:
        effect: ui
        event:
          object:
            name: "select_backup"
            backup:
              object:
                database:
                  any: text
                backup:
                  any: text
                kind:
                  any: text
                started:
                  any: text
                status:
                  any: text
                env:
                  any: text
    backup_acknowledged:
      object:
        effect: ws
        data:
          backup: "ack"
    backups_activity:
      object:
        effect: ws
        data:
          object:
            backups:
              object:
                active:
                  any: object
                pending:
                  any: object
    cancel_backup:
      object:
        effect: "ui"
        event:
          object:
            name: "cancel-backup"
            id:
              any: number
  update:
    show_backups:
      cmds:
        - effect: ws
          encoder: backups_query
        - effect: ui
          encoder: backups_view
    backups:
      model:
        backups:
          key: backups
          in: data
      cmds:
        - effect: ui
    backup_selected:
      model:
        backup:
          key: backup
          in: event
      cmds:
        - effect: ui
          encoder: backups_view
    backup_acknowledged:
      model:
        inspector: 
          object:
            visibility: "visible"
            view: "activity_view"
            content_key: "activity"
      cmds:
        - effect: ui
    backups_activity:
      model:
        backups_activity:
          key: backups
          in: data
      cmds:
        - effect: ws
          encoder: backups_query
        - effect: ui
    cancel_backup:
      model:
        object:
          backup_job_id:
            key: id 
            in: event
      cmds:
        - effect: ws
          encoder: cancel_backup
        - effect: ui
  encoders:
    backups_query:
      object:
        action: "backups"
    cancel_backup:
      object:
        action: "cancel"
        backup:
          key: backup_job_id
    subscribe_to_backups:
      object:
        action: subscribe
        topic: backups 
    backup_activity_item_view:
      object:
        action: "cancel-backup"
        icon: "fas fa-cloud-upload-alt"
        id:
          key: id
        title:
          format:
            pattern: "~a in ~a"
            params:
              - key: database
              - key: env
        subtitle:
          key: status
        date:
          key: timestamp
    backup_status_label:
      view:
        view: status-label
        params:
          object:
            style:
              either:
                - when: 
                    eq:
                      - text: "success"
                      - key: status
                  text: "success"
                - text: "danger"
            title:
              either:
                - when: 
                    eq:
                      - text: "success"
                      - key: status
                  text: "Success"
                - text: "Error"
    backup_item_view:
      view:
        tag: div
        attrs:
          class: "row"
          key: 
            key: backup
            in: item
          onclick:
            object:
              name: "select_backup"
              backup:
                key: item
        children:
          - tag: div
            attrs:
              class: "status"
            children:
              - view: backup_status_label
                params:
                  object:
                    status:
                      key: status
                      in: item
          - tag: div
            attrs:
              class: "content"
            children:
              - tag: div
                attrs:
                  class: "info"
                children:
                  - timestamp:
                      format: human
                      value:
                        key: started 
                        in: item
              - tag: h6
                children:
                  - text:
                      key: database
                      in: item
              - tag: div
                children:
                  - tag: div
                    attrs:
                      class: "wide"
                    children:
                      - view: default-status-label 
                        params:
                          object:
                            title:
                              key: kind
                              in: item
                      - view: default-status-label
                        params:
                          object:
                            title:
                              key: env
                              in: item
    backups_table_view:
      view:
        tag: div
        attrs:
          class: "table"
        children:
          - tag: div
            attrs:
              class: "title"
            children:
              - tag: h6 
                children:
                  - text: "Backups"
              - tag: span 
                children:
                  - text: "List of backups made in the last week"
          - tag: div
            attrs:
              class: "body"
            children:
              loop:
                key: backups 
              with: backup_item_view
    backups_panel_view:
      view:
        tag: div
        attrs:
          class: "column col-xl-8 col-lg-8 col-md-8 col-sm-12 col-xs-12"
        children:
          - view: panel
            params:
              object:
                style: "reports filled"
                view: backups_table_view
                content:
                  object:
                    backups:
                      key: backups
    restore_button_view:
      view:
        tag: div
        attrs:
          class: "row"
        children:
          - tag: div
            attrs:
              class: "info"
            children:
              - view: button
                params:
                  object:
                    style: "btn-sm primary"
                    title: "Restore"
                    onclick:
                      object:
                        event: "restore"
          - tag: div
            children:
              - tag: div
                attrs:
                  class: "title"
                children:
                  - text:
                      key: title
              - tag: div
                attrs:
                  class: "description"
                children:
                  - text:
                      key: description
    backup_detail_view:
      view:
        tag: div
        attrs:
          class: "form"
        children:
          - tag: div
            attrs:
              class: "info"
            children:
              - tag: div
                attrs:
                  class: "status wide"
                children:
                  - view: backup_kind_label
                    params:
                      object:
                        title:
                          key: kind
                          in: backup 
                  - view: backup_env_label
                    params:
                      object:
                        env:
                          key: env
                          in: backup
                  - view: backup_status_label
                    params:
                      object:
                        status:
                          key: status
                          in: backup
          - tag: div
            attrs:
              class: "title"
            children:
              - text:
                  key: database 
                  in: backup
          - tag: div
            attrs:
              class: "subtitle"
            children:
              - timestamp:
                  format: human
                  value:
                    key: started 
                    in: backup
          - tag: div
            attrs:
              class: "actions"
            children:
              - view: restore_button_view 
                params:
                  object:
                    title: "Restore in Dev"
                    description: "Restore this backup in a development environment"
              - view: restore_button_view
                params:
                  object:
                    title: "Restore in Preprod"
                    description: "Restore this backup in a preprod environment"

    selected_backup_view:
      view:
        tag: div
        attrs:
          class: "column col-6"
          style: "max-height: 8rem; height: 8rem"
        children:
          - view: panel
            params:
              object:
                view: backup_detail_view
                style: "filled"
                content:
                  backup:
                    key: backup
    no_backup_selection_view:
      view:
        tag: div
        attrs:
          class: "column col-6"
          style: "max-height: 8rem; height: 8rem"
        children:
          - view: dialog
            params:
              object:
                title: "No backup selected"
                subtitle: "Please select a backup from the list on the left"
    backups_dashboard:
      view:
        view: main
        params:
          object:
            title: "Backups"
            subtitle: "Available database backups"
            icon: "fas fa-cloud-upload-alt"
            views:
              list:
                - object:
                    name: databases_panel_view
                    content:
                      object: 
                        databases:
                          key: databases
                - object:
                    name: backups_panel_view
                    content:
                      object:
                        backups:
                          key: backups
    backups_view:
      view:
        view: nkpanel_view
        params:
          object:
            prefs:
              key: prefs
            inspector:
              object:
                status:
                  key: inspector
                content:
                  encoder: inspector_content
            feature:
              object:
                name: "backups"
                view: "backups_dashboard"
                content:
                  object:
                    databases:
                      key: databases
                    backups:
                      key: backups
                    backup:
                      maybe:
                        key: backup

