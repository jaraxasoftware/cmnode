version: 1.0
type: module
category: server
name: assets_api 
spec:
  decoders:
    health:
      object:
        headers:
          object:
            content-length: 
              text:
                literal: "0"
    asset_query:
      object:
        query:
          id:
            any: text
    s3_not_found:
      object:
        stream:
          keyword: s3
        event:
          keyword: error 
        data:
          object:
            status: 404
    s3_start:
      object:
        stream:
          keyword: s3
        event:
          keyword: start
        data:
          any: object
    s3_data:
      object:
        stream:
          keyword: s3
        event:
          keyword: data
        data:
          any: data
    s3_end:
      object:
        stream:
          keyword: s3
        event:
          keyword: end
        data: 
          any: object
    s3_error:
      object:
        stream:
          keyword: s3
        event:
          keyword: error
        data: 
          any: object
  update:
    health:
      cmds:
        - effect: notify
          encoder: health
    asset_query:
      - when: 
          eq:
            - text: none
            - key: id
              in: 
                key: query
                in: data
        cmds:
          - effect: terminate
      - model:
          id: 
            key: id
            in: query
          type:
            keyword: image
        cmds:
          - effect: file
            encoder: thumbnail_query
    s3_not_found:
      cmds:
        - effect: notify
          encoder: not_found
        - effect: terminate
    s3_start:
      model:
        stream:
          object:
            event:
              keyword: start
            data:
              object:
                content-type:
                  text: "image/jpeg"
                content-length:
                  key: content-length
                  in:
                    key: headers
                    in:
                      key: data
      cmds:
        - effect: stream
          encoder: stream 
    s3_data:
      model:
        stream:
          object:
            event:
              keyword: data
            data:
              key: data
      cmds:
        - effect: stream
          encoder: stream 
    s3_end:
      model:
        stream:
          object:
            event:
              keyword: end
            data:
              key: data
      cmds:
        - effect: stream
          encoder: stream 
        - effect: terminate
    s3_error:
      cmds:
        - effect: terminate
  encoders:
    health:
      object:
        status: 
          keyword: ok
    not_found:
      object:
        status: 404
    thumbnail_query:
      object:
        stream:
          keyword: s3
        asset:
          join:
            - key: id
            - text: "-big.jpg"
    stream:
      key: stream
