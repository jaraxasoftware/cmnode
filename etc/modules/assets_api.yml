version: 1.0
type: module
category: server
name: assets_api 
spec:
  decoders:
    health:
      object:
        headers:
          object:
            content-length: 
              text:
                literal: "0"
    asset_query:
      object:
        query:
          id:
            any: text
    image_info:
      object:
        value:
          object:
            url: 
              any: text
    image_data:
      object:
        headers:
          any: object
        body:
          any: list
        status: 200
    thumb_not_found:
      object:
        context:
          keyword: thumb
        status: 404
  update:
    health:
      cmds:
        - effect: notify
          encoder: health
    asset_query:
      - when: 
          eq:
            - text: none
            - key: id
              in: 
                key: query
                in: data
        cmds:
          - effect: terminate
      - model:
          id: 
            key: id
            in: query
          type:
            keyword: image
        cmds:
          - effect: http
            encoder: thumbnail_query
    thumb_not_found:
        cmds:
          - effect: http
            encoder: original_query
    image_data:
      model:
        asset_data:
          object:
            status: 200
            headers:
              key: headers
            body:
              key: body
      cmds:
        - effect: notify
          encoder: image_data
        - effect: terminate
  encoders:
    health:
      object:
        status: 
          keyword: ok
    thumbnail_query:
      object:
        context:
          keyword: thumb
        method: 
          keyword: get 
        url:
          join:
            - text: "https://s3.eu-west-3.amazonaws.com/"
            - config: s3_bucket
            - text: "/"
            - key: id
            - text: "/25.jpeg"
    original_query:
      object:
        context:
          keyword: original
        method: 
          keyword: get 
        url:
          join:
            - text: "https://s3.eu-west-3.amazonaws.com/"
            - config: s3_bucket
            - text: "/"
            - key: id
            - text: "/original.jpeg"
    image_data:
      key: asset_data
