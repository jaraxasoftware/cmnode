version: 1.0
type: module
category: server
name: assets_api 
spec:
  decoders:
    health:
      object:
        headers:
          object:
            content-length: 
              text:
                literal: "0"
    asset_query:
      object:
        query:
          id:
            any: text
    s3_start:
      object:
        stream:
          keyword: s3
        event:
          keyword: start
        data:
          object:
            headers:
              any: object
    s3_data:
      object:
        stream:
          keyword: s3
        event:
          keyword: data
        data:
          any: data
    s3_end:
      object:
        stream:
          keyword: s3
        event:
          keyword: end
        data: 
          any: object
    s3_error:
      object:
        stream:
          keyword: s3
        event:
          keyword: error
        data: 
          any: object
  update:
    health:
      cmds:
        - effect: notify
          encoder: health
    asset_query:
      - when: 
          eq:
            - text: none
            - key: id
              in: 
                key: query
                in: data
        cmds:
          - effect: terminate
      - model:
          id: 
            key: id
            in: query
          type:
            keyword: image
        cmds:
          - effect: file
            encoder: thumbnail_query
    s3_start:
      model:
        stream:
          object:
            event:
              keyword: start
            data:
              key: headers
              in:
                key: data
      cmds:
        - effect: stream
          encoder: stream 
    s3_data:
      model:
        stream:
          object:
            event:
              keyword: data
            data:
              key: data
      cmds:
        - effect: stream
          encoder: stream 
    s3_end:
      model:
        stream:
          object:
            event:
              keyword: end
            data:
              key: data
      cmds:
        - effect: stream
          encoder: stream 
        - effect: terminate
    s3_error:
      cmds:
        - effect: terminate
  encoders:
    health:
      object:
        status: 
          keyword: ok
    thumbnail_query:
      object:
        method: 
          keyword: get
        stream:
          keyword: s3
        path:
          join:
            - text: "/Users/pedrogutierrez/Projects/cmnode/data/weekonekt_assets/"
            - key: id
            - text: "-regular.jpg"
    stream:
      key: stream
