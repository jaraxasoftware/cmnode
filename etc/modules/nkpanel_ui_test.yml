version: 1.0
type: module
category: ui
name: nkpanel_ui_test
spec:
  init:
    model:
      tests: []
      reports: []
      test_activity: 
        object:
          active:
            object:
              items: []
              max: 10
              current: 0
          pending:
            object:
              items: []
              max: 10
              current: 0
  decoders:
    show_test:
      object:
        effect: "ui"
        event: "show_test"
    reports:
      object:
        effect: "ws"
        data:
          object:
            test_reports:
              any: list
    tests:
      object:
        effect: "ws"
        data:
          object:
            tests:
              any: list
    test_activity:
      object:
        effect: "ws"
        data:
          object:
            tests:
              object:
                active:
                  any: object
                pending:
                  any: object
    run_test:
      object:
        effect: "ui"
        event:
          object:
            name: "run-test"
            test:
              any: text
  update:
    reports:
      model:
        object:
          reports:
            key: test_reports
            in: data
      cmds:
        - effect: ui
    tests:
      model:
        object:
          tests:
            key: tests
            in: data
      cmds:
        - effect: ui
    show_test:
      model:
        object:
          reports: []
          tests: []
      cmds:
        - effect: ui
          encoder: test_view
        - effect: ws
          encoder: subscribe_to_tests
        - effect: ws
          encoder: tests
        - effect: ws
          encoder: test_reports
        - effect: ws
          encoder: test_activity_query
    run_test:
      model:
        inspector: "active"
        test_name: 
          key: test
          in: event
      cmds:
        - effect: ws
          encoder: run_test_query
    test_activity:
      model:
        test_activity:
          key: tests
          in: data
      cmds:
        - effect: ws
          encoder: test_reports
        - effect: ui
  encoders:
    tests:
      object:
        action: tests
    subscribe_to_tests:
      object:
        action: subscribe
        topic: tests
    test_reports:
      object:
        action: test_reports
        days: 7 
    test_activity_query:
      object:
        action: "test_activity"
    run_test_query:
      object:
        action:  "schedule"
        settings: "dev"
        test:
          key: test_name
    report_status_badge:
      view:
        view: status-label
        params:
          object:
            style:
              either:
                - when: 
                    eq:
                      - key: fail
                      - number: 0
                  text: "success"
                - when: 
                    eq:
                      - key: success
                      - number: 0
                  text: "danger"
                - text: "warning"
            title:
              either:
                - when: 
                    eq:
                      - key: fail
                      - number: 0
                  text: "Pass"
                - when: 
                    eq:
                      - key: success
                      - number: 0
                  text: "Error"
                - text: "Fail"
    report_table_item:
      view:
        tag: div
        attrs:
          class: "row"
          key: 
            key: id
            in: item
          onclick:
            object:
              show_report:
                key: id
                in: item
        children:
          - tag: "div"
            attrs:
              class: "status"
            children:
              - view: report_status_badge
                params:
                  key: scenarios
                  in: item
          - tag: div
            attrs:
              class: "content"
            children:
              - tag: div
                attrs:
                  class: "info"
                children:
                  - timestamp:
                      format: human
                      value:
                        key: timestamp
                        in: item
              - tag: h6
                children:
                  - text:
                      key: query
                      in: item
              - view: report_stats_view
                params:
                  key: item
    reports_table:
      view:
        tag: div
        attrs:
          class: "table"
        children:
          - tag: div
            attrs:
              class: "title"
            children:
              - tag: h6 
                children:
                  - text: "Reports"
              - tag: span 
                children:
                  - text: "Showing 20 most recent items"

          - tag: div
            attrs:
              class: "body"
            children:
              loop:
                key: reports
              with: report_table_item
    test_table_item:
      view:
        tag: div
        attrs:
          class: "row"
          key:
            key: name
            in: item
          onclick:
            object:
              show_test:
                key: name
                in: item
        children:
          - tag: div
            attrs:
              class: "content"
            children:
              - view: button
                params:
                  object:
                    style: "btn-sm primary"
                    title: "Run"
                    onclick:
                      object:
                        name: "run-test"
                        test: 
                          key: name
                          in: item
              - tag: h6
                children:
                  - text:
                      key: name
                      in: item
              - tag: span
                children:
                  - text: 
                      format: 
                        pattern: "~a scenarios"
                        params:
                        - key: scenarios
                          in: item
    tests_table:
      view:
        tag: div
        attrs:
          class: "table"
        children:
          - tag: div
            attrs:
              class: "title"
            children:
              - tag: h6 
                children:
                  - text: "Tests"
              - tag: span 
                children:
                  - text: "All available test definitions"

          - tag: div
            attrs:
              class: "body"
            children:
              loop:
                key: tests
              with: test_table_item
    tests_view:
      view:
        tag: div
        attrs:
          class: "column col-4"
        children:
          - view: panel
            params:
              object:
                style: "tests"
                view: tests_table
                content:
                  object:
                    tests:
                      key: tests
    reports_view:
      view:
        tag: div
        attrs:
          class: "column col-8"
        children:
          - view: panel
            params:
              object:
                style: "reports filled"
                view: reports_table
                content:
                  object:
                    reports:
                      key: reports
    test_dashboard:
      view:
        view: main
        params:
          object:
            title: "Test"
            subtitle: "Available tests and reports"
            icon: "far fa-check-square"
            views:
              list:
                - object:
                    name: tests_view
                    content:
                      object:
                        tests:
                          key: tests
                - object:
                    name: reports_view
                    content:
                      object:
                        reports:
                          key: reports
    test_view:
      view:
        view: nkpanel_view
        params:
          object:
            inspector:
              object:
                view: activity
                visibility: 
                  key: inspector
                content:
                  current:
                    key: active
                    in: test_activity
                  waiting:
                    key: pending
                    in: test_activity
            feature:
              object:
                name: "test"
                view: "test_dashboard"
                content:
                  object:
                    tests:
                      key: tests
                    reports:
                      key: reports
