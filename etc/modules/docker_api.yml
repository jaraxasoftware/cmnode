version: 1.0
type: module
category: server
name: docker_api 
spec:
  decoders:
    webclient_ready:
      object:
        body:
          push_data:
            object:
              tag:
                any: text
          repository:
            object:
              name:
                one_of:
                  - text: "dkv-client"
                  - text: "c4-client"
                  - text: "sphera-brazil-cient"
                  - text: "sphera-rwanda-client"
                  - text: "sphera-videocal-client"
              repo_name:
                any: text
    tag_ready:
      object:
        body:
          push_data:
            object:
              tag:
                any: text
          repository:
            object:
              name:
                any: text
              repo_name:
                any: text
  update:
    webclient_ready:
      model:
        docker_image:
          object:
            name:
              key: name
              in:
                key: repository
                in: body
            repo:
              key: repo_name
              in: 
                key: repository
                in: body
            tag:
              key: tag
              in: 
                key: push_data
                in: body
      cmds:  
        - effect: task
          encoder: docker_ready_task
        - effect: task
          encoder: webclient_dev_deploy_task
        - effect: notify
          encoder: ok
    tag_ready:
      model:
        docker_image:
          object:
            name:
              key: name
              in:
                key: repository
                in: body
            repo:
              key: repo_name
              in: 
                key: repository
                in: body
            tag:
              key: tag
              in: 
                key: push_data
                in: body
      cmds:  
        - effect: task
          encoder: docker_ready_task
        - effect: notify
          encoder: ok
  encoders:
    ok:
      object:
        status: 
          keyword: ok
    docker_ready_task:
      object:
        task:
          keyword: docker_announce
        params:
          object:
            name:
              key: name
              in: docker_image
            repo:
              key: repo
              in: docker_image
            tag:
              key: tag
              in: docker_image
            slack:
              keyword: tests
            settings:
              keyword: dev
    webclient_dev_deploy_task:
      object:
        task:
          keyword: webclient_deploy
        params:
          object:
            name:
              key: name
              in: docker_image
            repo:
              key: repo
              in: docker_image
            tag:
              key: tag
              in: docker_image
            slack:
              keyword: tests
            settings:
              keyword: dev

