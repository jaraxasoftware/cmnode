version: 1.0
type: module
category: server
name: restore_api 
spec:
  decoders:
    restore_summary:
      object:
        method: "POST"
        headers:
          object:
            content-type: "application/json"
            app-id: "nk"
            app-secret: "nk"
        body:
          object:
            restore_summary:
              object:
                env:
                  any: text
                backup:
                  any: text
                kind:
                  one_of:
                    - elastic
                    - cockroach
                name:
                  any: text
                db:
                  any: text
                status:
                  one_of:
                    - error
                    - success
                job:
                  any: number
    start_restore:
      object:
        action: restore
        backup:
          object:
            backup:
              any: text
            database:
              any: text
            env:
              any: text
            name:
              any: text
            kind:
              one_of:
                - elastic
                - cockroach
    restore_error:
      object:
        status:
          keyword: error
        context:
          one_of:
            - keyword: new_restore
    restore_ack:
      object:
        status: 
          keyword: ok
        context:
          keyword: new_restore
    restores_subscription:
      object:
        action: subscribe
        topic: restores
    restores_notification:
      object:
        restores:
          any: object
    cancel_restore:
      object:
        action: cancel
        restore:
          any: number
    restore_cancelled:
      object:
        context:
          keyword: cancel_restore
        status:
          keyword: ok
    restore_finished:
      object:
        context:
          keyword: finish_restore
  update:
    restore_summary:
      model:
        restore:
          key: restore_summary
          in: body
      cmds:
        - effect: queue
          encoder: restore_job_finished
    restore_error:
      cmds:
        - effect: notify
          encoder: restore_error
    start_restore:
      - when:
          encoder: is_admin
        model:
          new_restore:
            key: backup
        cmds:
          - effect: queue
            encoder: restore_job
      - cmds:
          - effect: notify
            encoder: forbidden
    restore_ack:
      cmds:
        - effect: notify
          encoder: restore_ack
    restores_subscription:
      - when:
          encoder: is_admin
        cmds:
          - effect: queue
            encoder: restores_subscription
      - cmds:
          - effect: notify
            encoder: forbidden
    restores_notification:
      model:
        restores_status:
          key: restores
      cmds:
        - effect: notify
          encoder: restores_status
    cancel_restore:
      - when:
          encoder: is_admin
        model:
          restore_job:
            key: restore
        cmds:
          - effect: queue
            encoder: restore_job_cancellation
      - cmds:
          - effect: notify
            encoder: forbidden
    restore_cancelled:
      cmds:
        - effect: notify
          encoder: restore_ack
    restore_finished:
      model:
        restore_job: "finished"
      cmds:
        - effect: notify
          encoder: restore_summary_ack
        - effect: terminate
  encoders:
    restores_status:
      object:
        restores:
          key: restores_status
    restore_ack:
      object:
        restore: "ack"
    restore_job:
      object:
        queue:
          keyword: restores_queue
        context:
          keyword: new_restore
        info:
          object:
            status: "Not started"
            backup:
              key: backup
              in: new_restore
            name:
              key: name
              in: new_restore
            database:
              key: database
              in: new_restore
            env:
              key: env
              in: new_restore
            kind:
              key: kind
              in: new_restore
        task:
          keyword: restore
        params:
          object:
            backup:
              key: backup
              in: new_restore
            name:
              key: name
              in: new_restore
            database:
              key: database
              in: new_restore
            kind:
              key: kind
              in: new_restore
            settings:
              key: env
              in: new_restore
    restore_job_cancellation:
      object:
        queue:
          keyword: restores_queue
        context:
          keyword: cancel_restore
        cancel:
          key: restore_job
    restore_job_finished:
      object:
        queue:
          keyword: restores_queue
        context:
          keyword: finish_restore
        finish:
          key: job
          in: restore
    restore_error:
      object:
        restore: "error"
    restores_subscription:
      object:
        context: 
          keyword: subscribe
        queue: 
          keyword: restores_queue
        topic: 
          keyword: restores
    restore_summary_ack:
      object:
        status: 200
        headers:
          content-type: "application/json"
        body:
          object:
            acknowledged: true
