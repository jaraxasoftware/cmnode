version: 1.0
type: module
category: server
name: login_api
spec:
  init:
    model:
      roles:
        list: [] 
  decoders:
    login:
      object:
        action:
          text: 
            literal: "login"
        username:
          email: any
        password:
          text: any
    email_not_found:
      object:
        context:
          keyword: login_email
        error:
          keyword: not_found
    user_not_found:
      object:
        context:
          keyword: login_user
        error:
          keyword: not_found
    user_found:
      object:
        context:
          keyword: login_user
        value:
          object:
            first:
              text: any
            last:
              text: any
            email:
              text: any
            id:
              text: any
    roles_found:
      object:
        bucket:
          keyword: users
        type:
          keyword: roles
        value:
          list:
            with:
              config: role
    roles_invalid:
      priority: lowest 
      object:
        bucket:
          keyword: users
        type:
          keyword: roles
        value:
          list: 
            without:
              config: role
    roles_not_found:
      object:
        bucket:
          keyword: users
        type:
          keyword: roles
        error:
          keyword: not_found 
    password_found:
      object:
        context:
          keyword: password
        value:
          text: any
    email_found:
      object:
        context:
          keyword: login_email
        value:
          text: any
    password_ok:
      object:
        context:
          keyword: password_check
        verified:
          keyword: true
    password_mismatch:
      object:
        context:
          keyword: password_check
        verified:
          keyword: false
  encoders:
    login_email_lookup:
      object:
        context:
          keyword: login_email 
        bucket:
          keyword: users
        type:
          keyword: email
        id: 
          key: email
    login_user_lookup:
      object:
        context:
          keyword: login_user
        bucket:
          keyword: users
        type:
          keyword: user 
        id: 
          key: uuid
    login_roles_lookup:
      object:
        context:
          keyword: login_roles
        bucket:
          keyword: users
        type:
          keyword: roles 
        id: 
          key: uuid
        all:
          keyword: true
    user_password_lookup:
      object:
        context: 
          keyword: password
        bucket:
          keyword: users
        type: 
          keyword: password
        id:
          key: uuid
    invalid:
      object:
        error:
          keyword: invalid
    not_found:
      object:
        error:
          keyword: not_found
    forbidden:
      object:
        error:
          keyword: forbidden 
    password_check:
      object:
        context:
          keyword: password_check
        hash:
          key: password_in_db
        clear:
          key: password
    login_user_data:
      object:
        first:
          key: first
          in: user
        last:
          key: last
          in: user
        email:
          key: email
          in: user
        id: 
          key: id
          in: user
        roles:
          key: roles
  update:
    invalid:
      cmds:
        - effect: notify
          encoder: invalid
    login:
      model:
        email:
          key: username
        password:
          key: password
      cmds:
        - effect: db_get
          encoder: login_email_lookup
    email_not_found:
      cmds:
        - effect: notify
          encoder: not_found
    user_not_found:
      cmds:
        - effect: notify
          encoder: not_found
    email_found:
      model:
        uuid:
          key: value 
      cmds:
        - effect: db_get
          encoder: user_password_lookup
    user_found:
      model:
        user:
          key: value
      cmds:
        - effect: db_get
          encoder: login_roles_lookup
    roles_not_found:
      cmds:
        - effect: notify
          encoder: forbidden
    roles_invalid:
      cmds:
        - effect: notify
          encoder: forbidden
    roles_found:
      model:
        roles:
          key: value
      cmds:
        - effect: notify
          encoder: login_user_data
    password_found:
      model:
        password_in_db:
          key: value
      cmds:
        - effect: crypt_verify
          encoder: password_check
    password_mismatch:
      cmds: 
        - effect: notify
          encoder: forbidden
    password_ok:
      cmds:
        - effect: db_get
          encoder: login_user_lookup
