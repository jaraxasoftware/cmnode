version: 1.0
type: module
category: server
name: projects_api 
spec:
  decoders:
    list_projects:
      object:
        action: 
          text: 
            literal: "projects"
    create_project:
      object:
        action: 
          text: 
            literal: "create_project"
        name:
          any: text
        description:
          any: text
    edit_project:
      object:
        action: 
          text: 
            literal: "edit"
        project:
          any: text
        name:
          any: text
        description:
          any: text
    project_info:
      object:
        action: 
          text: 
            literal: "info"
        project:
          any: text
    projects:
      object:
        context:
          keyword: my_projects
        bucket:
          keyword: tracker
        type: 
          keyword: projects
        value: 
          list: any
    projects_not_found:
      object:
        context:
          keyword: my_projects
        bucket:
          keyword: tracker
        type: 
          keyword: projects
        error:
          keyword: not_found
    project_found_for_info:
      object:
        context:
          keyword: info
        bucket:
          keyword: tracker
        type: 
          keyword: project
        value:
          object:
            id:
              any: text
            status:
              any: keyword
            name:
              any: text
            description: 
              any: text
    project_found_for_edit:
      object:
        context:
          keyword: edit
        bucket:
          keyword: tracker
        type: 
          keyword: project
        value:
          object:
            id:
              any: text
            status:
              one_of:
                - keyword: planning
                - keyword: started
                - keyword: abandoned
    project_owner_for_edit:
      object:
        context:
          keyword: edit
        bucket:
          keyword: tracker
        type: 
          keyword: owner 
        value:
          any: text
    project_members_for_info:
      object:
        context:
          keyword: info
        bucket:
          keyword: tracker
        type: 
          keyword: members 
        value:
          any: list
    project_not_found:
      object:
        bucket:
          keyword: tracker
        type: 
          keyword: project
        error:
          keyword: not_found
    tracker_written:
      object:
        bucket: 
          keyword: tracker
        status:
          keyword: ok
    project_uuid:
      object:
        context:
          keyword: project
        uuid:
          text: any
  encoders:
    project_context:
      object:
        context:
          keyword: project
    my_projects_lookup:
      object:
        context:
          keyword: my_projects
        bucket:
          keyword: tracker
        type:
          keyword: projects
        id:
          key: id
          in:
            key: user
    project_lookup_for_edit:
      object:
        context:
          keyword: edit
        bucket:
          keyword: tracker
        type:
          keyword: project
        id:
          key: project
    project_lookup_for_info:
      object:
        context:
          keyword: info
        bucket:
          keyword: tracker
        type:
          keyword: project
        id:
          key: project
    project_owner_lookup_for_edit:
      object:
        context:
          keyword: edit
        bucket:
          keyword: tracker
        type:
          keyword: owner
        id:
          key: project
    projects:
      object:
        projects:
          key: projects
    project_entries:
      object:
        context:
          keyword: create 
        bucket:
          keyword: tracker
        new:
          keyword: true
        items:
          list:
            - object: 
                type: 
                  keyword: name
                id: 
                  key: name
                value:
                  key: uuid
            - object:
                type:
                  keyword: project
                id:
                  key: uuid
                value:
                  object:
                    name: 
                      key: name
                    description: 
                      key: description
                    status:
                      key: project_status
                    id:
                      key: uuid
            - object:
                type:
                  keyword: owner
                id:
                  key: uuid
                value:
                  key: id
                  in:
                    key: user
            - object:
                type:
                  keyword: projects
                id:
                  key: id
                  in:
                    key: user
                value:
                  key: uuid
            - object:
                type:
                  keyword: members
                id:
                  key: uuid
                value:
                  key: id
                  in:
                    key: user
    updated_project:
      object:
        context:
          keyword: edit_project
        bucket:
           keyword: tracker
        items:
          list:
            - object:
                type:
                  keyword: project
                id:
                  key: uuid
                value:
                  object:
                    name:
                      key: name
                    description:
                      key: description
                    status:
                      key: status
                      in: project
                    id:
                      key: id
                      in: project
    project:
      object:
        project:
          object:
            name: 
              key: name
            description:
              key: description
            id:
              key: uuid
            status:
              key: project_status
            owner:
              key: id
              in:
                key: user
    project_members_for_info:
      object:
        context:
          keyword: info
        bucket:
          keyword: tracker
        type:
          keyword: members
        id:
          key: project
        all:
          keyword: true
  update:
    list_projects:
      - when:
          encoder: is_admin
        cmds:
          - effect: db_get
            encoder: my_projects_lookup
      - cmds:
          - effect: notify
            encoder: forbidden
    project_uuid:
      model:
        uuid:
          key: uuid
        project_status:
          keyword: planning
      cmds:
          - effect: db_put
            encoder: project_entries
    create_project:
      - when:
          encoder: is_admin
        model:
          name:
            key: name
          description:
            key: description
        cmds:
          - effect: uuid
            encoder: project_context
      - cmds:
          - effect: notify
            encoder: forbidden
    edit_project:
      - when:
          encoder: is_admin
        model:
          project:
            key: project
          name:
            key: name
          description:
            key: description
          state:
            keyword: editing_project
        cmds:
          - effect: db_get
            encoder: project_owner_lookup_for_edit
      - cmds:
          - effect: notify
            encoder: forbidden
    project_info:
      model:
        project:
          key: project
      cmds:
        - effect: db_get
          encoder: project_members_for_info
    project_members_for_info:
      - when:
          member:
            value:
              key: id
              in:
                key: user
                in: model
            of:
              key: value
              in: data
        cmds:
          - effect: db_get
            encoder: project_lookup_for_info
      - cmds:
          - effect: notify
            encoder: forbidden
    project_owner_for_edit:
      - when:
          eq:
            - key: value
              in: data
            - key: id
              in:
                key: user
                in: model
        cmds:
          - effect: db_get
            encoder: project_lookup_for_edit
      - cmds:
          - effect: notify
            encoder: forbidden
    project_found_for_info:
      model:
        project:
          key: value
      cmds:
        - effect: notify
          encoder: project
    project_found_for_edit:
      model:
        project:
          key: value
      cmds:
        - effect: db_put
          encoder: updated_project
    project_not_found:
      cmds:
        - effect: notify
          encoder: not_found
    projects_not_found:
      model:
        projects: []
      cmds:
        - effect: notify
          encoder: projects
    tracker_written:
      cmds:
        - effect: notify
          encoder: project
    projects:
      model:
        projects:
          key: values
      cmds:
        - effect: notify
          encoder: projects
