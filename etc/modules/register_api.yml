type: module
name: register_api
spec:
  decoders:
    register:
      object:
        method: POST
        body:
          object:
            first:
              non_empty: text
            last:
              non_empty: text
            email:
              any: email
            lang:
              any: text
            username:
              non_empty: text
    registered:
      object:
        service: user_create
        status:
          keyword: ok
        id:
          non_empty: text
    conflict:
      object:
        service: user_create
        status:
          keyword: conflict
    passwd_remind_token:
      object:
        service: passwd_remind
        status:
          keyword: ok
        token:
          any: text
    passwd_remind_sent:
      all:
        - object:
            service: passwd_remind
            status:
              keyword: ok
        - without_keys:
            - token
    passwd_remind_error:
      object:
        service: passwd_remind
        status:
          keyword: error
  update:
    register:
      model:
        details:
          key: body
      cmds:
        - effect: service 
          encoder: registration
    registered:
      model:
        id:
          key: id
      cmds:
        - effect: service
          encoder: passwd_remind
    conflict:
      cmds:
        - effect: terminate
          encoder: conflict
    passwd_remind_token:
      model:
        token:
          key: token
      cmds:
        - effect: terminate
          encoder: success_with_token
    passwd_remind_sent:
      cmds:
        - effect: terminate
          encoder: created
    passwd_remind_error:
      cmds:
        - effect: terminate
          encoder: created
  encoders:
    registration:
      object:
        service: user_create 
        params:
          merge:
            - key: details
            - object:
                bucket:
                  keyword:
                    key: app.db
    passwd_remind:
      object:
        service: passwd_remind
        params:
          object:
            bucket:
              keyword:
                key: app.db
            app: @app
            email:
              key: details.email
            lang:
              key: details.lang
            id:
              key: id
            token_ttl:
              key: app.password.reset.ttl
            token_key:
              key: app.password.reset.sign_key
    success_with_token:
      object:
        status: 201
        headers:
          content-type: application/json
        body:
          token:
            key: token
