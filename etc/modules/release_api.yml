version: 1.0
type: module
category: server
name: release_api 
spec:
  decoders:
    dkv_pet_proxy_release_triggered:
      object:
        release:
          object:
            component: "dkv-pet-proxy"
            increment:
              one_of:
                - text: "minor"
                - text: "patch"
                - text: "major"
    dkv_notifications_release_triggered:
      object:
        release:
          object:
            component: "dkv-notifications"
            increment:
              one_of:
                - text: "minor"
                - text: "patch"
                - text: "major"
    nimg_release_triggered:
      object:
        release:
          object:
            component: "nimg"
            increment:
              one_of:
                - text: "minor"
                - text: "patch"
                - text: "major"
    email_reports_release_triggered:
      object:
        release:
          object:
            component: "email-reports"
            increment:
              one_of:
                - text: "minor"
                - text: "patch"
                - text: "major"
    netcomp_release_triggered:
      object:
        release:
          object:
            component: "netcomp"
            instance:
              one_of:
                - text: "dkv"
                - text: "sipstorm"
                - text: "sphera-rwanda"
                - text: "sphera-brazil"
                - text: "sphera-general"
            increment:
              one_of:
                - text: "minor"
                - text: "patch"
                - text: "major"
  update:
    nimg_release_triggered:
      model:
        object:
          release:
            key: release
      cmds:
        - effect: task
          encoder: nimg_release_task
        - effect: notify
          encoder: release_ack
    email_reports_release_triggered:
      model:
        object:
          release:
            key: release
      cmds:
        - effect: task
          encoder: email_reports_release_task
        - effect: notify
          encoder: release_ack
    netcomp_release_triggered:
      model:
        object:
          release:
            key: release
      cmds:
        - effect: task
          encoder: netcomp_release_task
        - effect: notify
          encoder: release_ack
    dkv_pet_proxy_release_triggered:
      model:
        object:
          release:
            key: release
      cmds:
        - effect: task
          encoder: dkv_pet_proxy_release_task 
        - effect: notify
          encoder: release_ack
    dkv_notifications_release_triggered:
      model:
        object:
          release:
            key: release
      cmds:
        - effect: task
          encoder: dkv_notifications_release_task 
        - effect: notify
          encoder: release_ack
  encoders:
    release_ack:
      object:
        release:
          key: release
        status:  
          keyword: ack
    nimg_release_task:
      object:
        task:
          keyword: nimg_release
        params:
          object:
            slack:
              keyword: tests
            settings:
              keyword: dev
            increment:
              key: increment
              in: release
    email_reports_release_task:
      object:
        task:
          keyword: email_reports_release
        params:
          object:
            slack:
              keyword: tests
            settings:
              keyword: dev
            increment:
              key: increment
              in: release
    netcomp_release_task:
      object:
        task:
          keyword: netcomp_release_build
        params:
          object:
            name:
              key: instance
              in: release
            increment:
              key: increment
              in: release
            slack:
              keyword: tests
            settings:
              keyword: dev
    dkv_pet_proxy_release_task:
      object:
        task:
          keyword: pet_proxy_release
        params:
          object:
            slack:
              keyword: tests
            settings:
              keyword: dev
            increment:
              key: increment
              in: release
    dkv_notifications_release_task:
      object:
        task:
          keyword: dkv_notifications_release
        params:
          object:
            slack:
              keyword: tests
            settings:
              keyword: dev
            increment:
              key: increment
              in: release
