type: test 
name: common 
spec:
  config:
    retries: 50
    wait: 10
  facts:
    app: test
    baseHeaders:
      object:
        content-type: application/json
    admin: c93a2af4-e82e-44f2-8034-a72a42440341
  scenarios: []
  backgrounds:
    - title: "Given an empty database"
      steps:
        - "When I init"
        - "Then I should receive a 201 Created"
    - title: "Given that user is registered"
      steps:
        - "Register that user"
        - "Then I should receive a 201 Created"
    - title: "Given user alice with password foo"
      steps:
        - "Given no token"
        - "Given user details for alice"
        - "Register that user"
        - "Then I should receive a 201 Created"
        - "Then I should expect a token"
        - "Given alice's email"
        - "Given password foo"
        - "Given alice's username"
        - "When I reset that password"
        - "Then I should receive a 201 Created"
        - "Given no token"
    - title: "Given user bob with password foo"
      steps:
        - "Given no token"
        - "Given user details for bob"
        - "Register that user"
        - "Then I should receive a 201 Created"
        - "Then I should expect a token"
        - "Given bob's email"
        - "Given password foo"
        - "Given bob's username"
        - "When I reset that password"
        - "Then I should receive a 201 Created"
        - "Given no token"
    - title: "Given I am logged in"
      steps:
        - "When I login with email"
        - "Then I should expect a user"
        - "Then I should expect a token"
    - title: "Given I am logged in as alice"
      steps:
        - "Given no token"
        - "Given alice's email"
        - "Given password foo"
        - "When I login with email"
        - "Then I should expect a user"
        - "Then I should expect a token"
    - title: "Given I am logged in as bob"
      steps:
        - "Given no token"
        - "Given bob's email"
        - "Given password foo"
        - "When I login with email"
        - "Then I should expect a user"
        - "Then I should expect a token"
    - title: "Given a space"
      steps:
        - "When I create a space"
        - "Then I should receive a 201 Created"
        - "Then I should expect a space"
    - title: "Given bob is in that space"
      steps:
        - "Given bob's email"
        - "When I invite that email to that space"
        - "Then I should receive a 201 Created"
    - title: "Given a connection for alice"
      steps:
        - "Given name alice"
        - "When I connect"
        - "When I use that connection"
        - "Then that connection should be up"
    - title: "Given I am subscribed to that space"
      steps:
        - "When I subscribe to that space"
        - "Then I should receive a 201 Created"
  steps:
    - title: "Given no app"
      set:
        app: ""
    - title: "Given no token"
      set:
        token: ""
    - title: "Given a wrong app"
      set:
        app: "wrong"
    - title: "When I init"
      procedure: api
      params:
        method: post
        path: "/init"
        token: 
          key: facts.admin
    - title: "Register that user"
      procedure: api
      params:
        method: post
        path: "/register"
        body:
          key: data.details
    - title: "When I reset that password"
      procedure: api
      params:
        method: post
        path: "/password/reset"
        body:
          email:
            key: data.email
          password:
            key: data.password
    - title: "When I login with email"
      procedure: api
      params:
        debug: true
        method: post
        path: "/login"
        body:
          email:
            key: data.email
          password:
            key: data.password
    - title: "When I login with username"
      procedure: api
      params:
        debug: true
        method: post
        path: "/login"
        body:
          username:
            key: data.username
          password:
            key: data.password
    - title: "When I logout"
      procedure: api
      params:
        debug: true
        method: post
        path: "/logout"
    - title: "Given user details for alice"
      set:
        details:
          first: "Alice"
          last: "In Chains"
          email: "alice@mail.com"
          lang: "en"
          username: "alice"
    - title: "Given user details for bob"
      set:
        details:
          first: "Bob"
          last: "Dylan"
          email: "bob@mail.com"
          lang: "en"
          username: "bob"
    - title: "Given another email"
      set:
        details:
          merge:
            - key: data.details
            - object:
                email: "another@mail.com"
    - title: "Given another username"
      set:
        details:
          merge:
            - key: data.details
            - object:
                username: "another"
    - title: "When I wait 1 second"
      wait:
        seconds: 1
    - title: "When I wait 5 seconds"
      wait:
        seconds: 5
    - title: "Given alice's email"
      set:
        email: "alice@mail.com"
    - title: "Given alice's username"
      set:
        username: "alice"
    - title: "Given bob's email"
      set:
        email: "bob@mail.com"
    - title: "Given bob's username"
      set:
        username: "bob"
    - title: "Given a fake email"
      set:
        email: "fake@mail.com"
    - title: "Given a fake username"
      set:
        username: "fake"
    - title: "Given a fake token"
      set:
        token: "fake"
    - title: "Given a fake password"
      set:
        password: "fake"
    - title: "Given password foo"
      set:
        password: "foo"
    - title: "Then I should receive a 201 Created"
      expect:
        match:
          key: data.latest
        with:
          object:
            status: 201
    - title: "Then I should receive a 200 OK"
      expect:
        match:
          key: data.latest
        with:
          object:
            status: 200
    - title: "Expect a 409 Conflict"
      expect:
        match:
          key: data.latest
        with:
          object:
            status: 409
    - title: "Then it should be forbidden"
      expect:
        match:
          key: data.latest
        with:
          object:
            status: 401
    - title: "Then I should expect a user"
      expect:
        object:
          body:
            object:
              id:
                non_empty: text 
              first:
                non_empty: text
              last:
                non_empty: text
              email:
                any: email
      in:
        key: data.latest
      remember:
        user:
          key: body
    - title: "Then I should expect a token"
      expect:
        match:
          key: data.latest
        with:
          object:
            body:
              token:
                any: text
        remember:
          token:
            key: body.token
    - title: "When I create a space"
      procedure: api
      params:
        debug: true
        method: post
        path: "/spaces"
    - title: "Then I should expect a space"
      expect:
        object:
          body:
            object:
              id:
                non_empty: text
              title:
                non_empty: text
              owner:
                non_empty: text
      in:
        key: data.latest
      remember:
        space:
          key: body
    - title: "When I get my spaces"
      procedure: api
      params:
        debug: true
        method: get
        path: /spaces
    - title: "When I get that space"
      procedure: api
      params:
        debug: true
        method: get
        path:
          format: "/spaces/~s"
          params:
            - key: data.space.id
    - title: "Then I should have one item"
      expect:
        object:
          body:
            list:
              size: 1
      in:
        key: data.latest
    - title: "Then I should have two items"
      expect:
        object:
          body:
            list:
              size: 2
      in:
        key: data.latest
    - title: "Then I should be the owner of that space"
      expect:
        object:
          body:
            list:
              with:
                object:
                  role: owner
                  id:
                    key: data.space.id
      in:
        key: data.latest
    - title: "Then I should be a guest in that space"
      expect:
        object:
          body:
            list:
              with:
                object:
                  role: guest
                  id:
                    key: data.space.id
      in:
        key: data.latest
    - title: "Then all items should belong to that user"
      expect:
        object:
          body:
            list:
              object:
                owner:
                  key: data.user.id
      in:
        key: data.latest
    - title: "When I invite that email to that space"
      procedure: api
      params:
        debug: true
        method: post
        path: /invites
        body:
          space:
            key: data.space.id
          email:
            key: data.email
    - title: "Given name alice"
      set:
        name: alice
    - title: "When I connect"
      connect:
        key: settings.wsUrl
      headers:
        authorization:
          one_of:
            - key: data.token
            - ""
        app:
          one_of:
            - key: data.app
            - key: facts.app
      as: 
        key: data.name
    - title: "Then that connection should be up"
      probe:
        key: data.conn
      status: up
    - title: "Then that connection should be down"
      probe:
        key: data.conn
      status: down 
    - title: "When I use that connection"
      set:
        conn:
          key: data.name
    - title: "When I subscribe to that space"
      procedure: api
      params:
        debug: true
        method: post
        path: /subscriptions
        body:
          space:
            key: data.space.id
    - title: "When I get that space's roster"
      procedure: api
      params:
        debug: true
        method: get
        path:
          format: "/spaces/~s/roster"
          params:
            - key: data.space.id
    - title: "Then that user should be in that roster"
      expect:
        body:
          list:
            with:
              username:
                key: data.username
      in:
        key: data.latest
  procedures:
    - name: api
      spec:
        either:
          - when:
              is_set:
                key: params.body
            http:
              method:
                keyword: 
                  one_of:
                    - key: params.method
                    - get
              url:
                format: "~s~s"
                params:
                  - one_of:
                      - key: params.baseUrl
                      - key: settings.baseUrl
                  - key: params.path
              headers:
                merge:
                  - key: facts.baseHeaders
                  - object:
                      app:
                        one_of:
                          - key: data.app
                          - key: facts.app
                      authorization:
                        one_of:
                          - key: params.token
                          - key: data.token
                          - ""
              body:
                key: params.body
            debug:
              one_of:
                - key: params.debug
                - true
          - http:
              method:
                keyword: 
                  one_of:
                    - key: params.method
                    - get
              url:
                format: "~s~s"
                params:
                  - one_of:
                      - key: params.baseUrl
                      - key: settings.baseUrl
                  - key: params.path
              headers:
                merge:
                  - key: facts.baseHeaders
                  - object:
                      app:
                        one_of:
                          - key: data.app
                          - key: facts.app
                      authorization:
                        one_of:
                          - key: params.token
                          - key: data.token
                          - ""
            debug:
              one_of:
                - key: params.debug
                - true
      as:
        keyword:
          one_of:
            - key: params.as
            - latest
