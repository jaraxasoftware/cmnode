type: test 
name: api 
spec:
  include:
    - common
  scenarios:
    
    - title: "Should not allow anonymous connections"
      tags:
        - ws
      steps:
        - "Given name alice"
        - "When I connect"
        - "When I use that connection"
        - "Then that connection should be down"
    
    - title: "Should allow authenticated connections"
      tags:
        - ws
      steps:
        - "Given an empty database"
        - "Given user alice with password foo"
        - "Given I am logged in as alice"
        - "Given name alice"
        - "When I connect"
        - "When I use that connection"
        - "Then that connection should be up"
    
    - title: "Users should be able to subscribe to spaces"
      tags:
        - subscribe
      steps:
        - "Given an empty database"
        - "Given user alice with password foo"
        - "Given I am logged in as alice"
        - "Given a space"
        - "When I subscribe to that space"
        - "Then I should receive a 201 Created"

    - title: "It should not be possible to subscribe to a space I don't belong to"
      tags:
        - subscribe
      steps:
        - "Given an empty database"
        - "Given user alice with password foo"
        - "Given user bob with password foo"
        - "Given I am logged in as alice"
        - "Given a space"
        - "Given I am logged in as bob"
        - "When I subscribe to that space"
        - "Then it should be forbidden"

          ##- title: "Space participants should see presence from other participants"
          ##  debug: true
          ##  tags:
          ##    - presence
          ##    - current
          ##  steps:
          ##    - "Given an empty database"
          ##    - "Given user alice with password foo"
          ##    - "Given user bob with password foo"
          ##    - "Given I am logged in as alice"
          ##    - "Given a connection for alice"
          ##    - "Given a space"
          ##    - "Given I am subscribed to that space"
          ##    - "Given bob is in that space"
    
    - title: "Rosters should be available for participantes of a given space"
      tags:
        - roster
      steps:
        - "Given an empty database"
        - "Given user alice with password foo"
        - "Given user bob with password foo"
        - "Given I am logged in as alice"
        - "Given a connection for alice"
        - "Given a space"
        - "Given bob is in that space"
        - "Given I am logged in as bob"
        - "When I get that space's roster"
        - "Then I should receive a 200 OK"
        - "Given bob's username"
        - "Then that user should be in that roster"
        - "Given alice's username"
        - "Then that user should be in that roster"

    - title: "Non participants should not able to get a space roster"
      tags:
        - roster
      steps:
        - "Given an empty database"
        - "Given user alice with password foo"
        - "Given user bob with password foo"
        - "Given I am logged in as alice"
        - "Given a space"
        - "Given I am logged in as bob"
        - "When I get that space's roster"
        - "Then it should be forbidden"

    - title: "Space owners should be able to invite users to their spaces"
      tags:
        - spaces
        - invite
      steps:
        - "Given an empty database"
        - "Given user alice with password foo"
        - "Given user bob with password foo"
        - "Given I am logged in as alice"
        - "Given a space"
        - "Given bob's email"
        - "When I invite that email to that space"
        - "Then I should receive a 201 Created"
        - "When I invite that email to that space"
        - "Then I should receive a 201 Created"
        - "Given I am logged in as bob"
        - "When I get my spaces"
        - "Then I should receive a 200 OK"
        - "Then I should have one item"
        - "Then I should be a guest in that space"

    - title: "Users should not be allowed to invite others to spaces they don't own"
      tags:
        - spaces
        - invite
        - forbidden
      steps:
        - "Given an empty database"
        - "Given user alice with password foo"
        - "Given user bob with password foo"
        - "Given I am logged in as alice"
        - "Given a space"
        - "Given I am logged in as bob"
        - "Given bob's email"
        - "When I invite that email to that space"
        - "Then it should be forbidden"

    - title: "Should not allow anonymous users to create spaces"
      tags:
        - spaces
        - anonymous
      steps:
        - "Given an empty database"
        - "When I create a space"
        - "Then it should be forbidden"
    
    - title: "Should not allow users to create spaces without a proper app"
      tags:
        - spaces
        - forbidden 
      steps:
        - "Given an empty database"
        - "Given user alice with password foo"
        - "Given I am logged in"
        - "Given no app"
        - "When I create a space"
        - "Then it should be forbidden"
        - "Given a wrong app"
        - "Then it should be forbidden"
    
    - title: "Unauthorized users should not create spaces"
      tags:
        - spaces
        - forbidden 
      steps:
        - "Given an empty database"
        - "Given a fake token"
        - "When I create a space"
        - "Then it should be forbidden"

    - title: "Users should be able to create spaces in a valid app"
      tags:
        - spaces
      steps:
        - "Given an empty database"
        - "Given user alice with password foo"
        - "Given I am logged in"
        - "Given a space"
        - "When I get my spaces"
        - "Then I should receive a 200 OK"
        - "Then I should have one item"
        - "Then I should be the owner of that space"
        - "Given a space"
        - "When I get my spaces"
        - "Then I should receive a 200 OK"
        - "Then I should have two items"
        - "Then I should be the owner of that space"

    - title: "By default, spaces should be private"
      tags:
        - spaces
      steps:
        - "Given an empty database"
        - "Given user alice with password foo"
        - "Given I am logged in as alice"
        - "Given a space"
        - "Given user bob with password foo"
        - "Given I am logged in as bob"
        - "Given a space"
        - "Given I am logged in as alice"
        - "When I get my spaces"
        - "Then I should have one item"
        - "Then all items should belong to that user"
        - "Given I am logged in as bob"
        - "When I get my spaces"
        - "Then I should have one item"
        - "Then all items should belong to that user"

    - title: "Should not allow to init without a proper app"
      tags:
        - register
        - forbidden
      steps:
        - "Given no app"
        - "When I init"        
        - "Then it should be forbidden"
        - "Given a wrong app"
        - "When I init"        
        - "Then it should be forbidden"
    
    - title: "Should not allow to register without a proper app"
      tags:
        - register
        - forbidden
      steps:
        - "Given an empty database"
        - "Given user details for alice"
        - "Given no app"
        - "Register that user"
        - "Then it should be forbidden"
        - "Given a wrong app"
        - "Register that user"
        - "Then it should be forbidden"
    
    - title: "Should not allow to register with a token"
      tags:
        - register
        - forbidden
      steps:
        - "Given an empty database"
        - "Given user alice with password foo"
        - "Given I am logged in"
        - "Given user details for bob"
        - "Register that user"
        - "Then it should be forbidden"

    - title: "Should not register email twice"
      tags:
        - register
      steps:
        - "Given an empty database"
        - "Given user details for alice"
        - "Given that user is registered"
        - "Given another username"
        - "Register that user"
        - "Expect a 409 Conflict"

    - title: "Should not register username twice"
      tags:
        - register
      steps:
        - "Given an empty database"
        - "Given user details for alice"
        - "Given that user is registered"
        - "Given another email"
        - "Register that user"
        - "Expect a 409 Conflict"

    - title: "Should reset passwords"
      tags: 
        - passwd_reset
      steps:
        - "Given an empty database"
        - "Given user alice with password foo"
        - "Given a fake email"
        - "When I reset that password"
        - "Then it should be forbidden"
        - "Given alice's email"
        - "Given a fake token"
        - "When I reset that password"
        - "Then it should be forbidden"

    - title: "Should consume password reset tokens"
      tags: 
        - consume 
        - current2
      steps:
        - "Given an empty database"
        - "Given user alice with password foo"
        - "When I reset that password"
        - "Then it should be forbidden"
       
    - title: "Should login with email"
      tags:
        - login
      steps:
        - "Given an empty database"
        - "Given user alice with password foo"
        - "When I login with email"
        - "Then I should expect a user"
        - "Then I should expect a token"
        - "Given a fake password"
        - "When I login with email"
        - "Then it should be forbidden"
        - "Given password foo"
        - "Given a fake email"
        - "When I login with email"
        - "Then it should be forbidden"

    - title: "Should login with username"
      tags:
        - login
      steps:
        - "Given an empty database"
        - "Given user alice with password foo"
        - "When I login with username"
        - "Then I should expect a user"
        - "Then I should expect a token"
        - "Given a fake password"
        - "When I login with username"
        - "Then it should be forbidden"
        - "Given password foo"
        - "Given a fake username"
        - "When I login with username"
        - "Then it should be forbidden"
    
    - title: "Should not allow to login with a token"
      tags:
        - login
        - forbidden
      steps:
        - "Given an empty database"
        - "Given user alice with password foo"
        - "Given I am logged in"
        - "Then I should expect a token"
        - "When I login with username"
        - "Then it should be forbidden"

    - title: "Should logout"
      tags:
        - logout
      steps:
        - "Given an empty database"
        - "Given user alice with password foo"
        - "When I login with email"
        - "Then I should expect a token"
        - "When I logout"
        - "Then I should receive a 200 OK"
