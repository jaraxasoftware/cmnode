type: test 
name: api 
spec:
  config:
    retries: 50
    wait: 10
  facts:
    app: test
    baseHeaders:
      object:
        content-type: application/json
    admin: c93a2af4-e82e-44f2-8034-a72a42440341
  scenarios:
    - title: "Should not register email twice"
      tags:
        - register
      steps:
        - "Given an empty database"
        - "Given user details for alice"
        - "Given that user is registered"
        - "Given another username"
        - "Register that user"
        - "Expect a 409 Conflict"

    - title: "Should not register username twice"
      tags:
        - register
      steps:
        - "Given an empty database"
        - "Given user details for alice"
        - "Given that user is registered"
        - "Given another email"
        - "Register that user"
        - "Expect a 409 Conflict"

    - title: "Should reset passwords"
      tags: 
        - passwd_reset
      steps:
        - "Given an empty database"
        - "Given user alice with password foo"
        - "Given a fake email"
        - "When I reset that password"
        - "Then I should expect a forbidden error"
        - "Given alice's email"
        - "Given a fake token"
        - "When I reset that password"
        - "Then I should expect a forbidden error"

    - title: "Should consume password reset tokens"
      tags: 
        - consume 
      steps:
        - "Given an empty database"
        - "Given user alice with password foo"
        - "When I reset that password"
        - "Then I should expect a forbidden error"
       
    - title: "Should login with email"
      tags:
        - login
      steps:
        - "Given an empty database"
        - "Given user alice with password foo"
        - "When I login with email"
        - "Then I should expect a uid"
        - "Then I should expect a token"
        - "Given a fake password"
        - "When I login with email"
        - "Then I should expect a forbidden error"
        - "Given password foo"
        - "Given a fake email"
        - "When I login with email"
        - "Then I should expect a forbidden error"

    - title: "Should login with username"
      tags:
        - login
      steps:
        - "Given an empty database"
        - "Given user alice with password foo"
        - "When I login with username"
        - "Then I should expect a uid"
        - "Then I should expect a token"
        - "Given a fake password"
        - "When I login with username"
        - "Then I should expect a forbidden error"
        - "Given password foo"
        - "Given a fake username"
        - "When I login with username"
        - "Then I should expect a forbidden error"

    - title: "Should logout"
      tags:
        - logout
      steps:
        - "Given an empty database"
        - "Given user alice with password foo"
        - "When I login with email"
        - "Then I should expect a token"
        - "When I logout"
        - "Then I should receive a 200 OK"

  backgrounds:
    - title: "Given an empty database"
      steps:
        - "Reset the database"
        - "Expect a 201 Created"
    - title: "Given that user is registered"
      steps:
        - "Register that user"
        - "Expect a 201 Created"
    - title: "Given user alice with password foo"
      steps:
        - "Given user details for alice"
        - "Register that user"
        - "Expect a 201 Created"
        - "Then I should expect a token"
        - "Given alice's email"
        - "Given password foo"
        - "Given alice's username"
        - "When I reset that password"
        - "Expect a 201 Created"

  steps:
    - title: "Reset the database"
      procedure: api
      params:
        method: post
        path: "/init"
        headers:
          authorization: 
            key: facts.admin
    - title: "Register that user"
      procedure: api
      params:
        method: post
        path: "/register"
        body:
          key: data.details
    - title: "When I reset that password"
      procedure: api
      params:
        method: post
        path: "/password/reset"
        body:
          email:
            key: data.email
          password:
            key: data.password
          token:
            key: data.token
    - title: "When I login with email"
      procedure: api
      params:
        debug: true
        method: post
        path: "/login"
        body:
          email:
            key: data.email
          password:
            key: data.password
    - title: "When I login with username"
      procedure: api
      params:
        debug: true
        method: post
        path: "/login"
        body:
          username:
            key: data.username
          password:
            key: data.password
    - title: "When I logout"
      procedure: api
      params:
        debug: true
        method: post
        path: "/logout"
        headers:
          object:
            authorization:
              key: data.token
    - title: "Given user details for alice"
      set:
        details:
          first: "Alice"
          last: "In Chains"
          email: "alice@mail.com"
          lang: "en"
          username: "alice"
    - title: "Given another email"
      set:
        details:
          merge:
            - key: data.details
            - object:
                email: "another@mail.com"
    - title: "Given another username"
      set:
        details:
          merge:
            - key: data.details
            - object:
                username: "another"
    - title: "When I wait 1 second"
      wait:
        seconds: 1
    - title: "Given alice's email"
      set:
        email: "alice@mail.com"
    - title: "Given alice's username"
      set:
        username: "alice"
    - title: "Given a fake email"
      set:
        email: "fake@mail.com"
    - title: "Given a fake username"
      set:
        username: "fake"
    - title: "Given a fake token"
      set:
        token: "fake"
    - title: "Given a fake password"
      set:
        password: "fake"
    - title: "Given password foo"
      set:
        password: "foo"
    - title: "Expect a 201 Created"
      expect:
        match:
          key: data.latest
        with:
          object:
            status: 201
    - title: "Then I should receive a 200 OK"
      expect:
        match:
          key: data.latest
        with:
          object:
            status: 200
    - title: "Expect a 409 Conflict"
      expect:
        match:
          key: data.latest
        with:
          object:
            status: 409
    - title: "Then I should expect a forbidden error"
      expect:
        match:
          key: data.latest
        with:
          object:
            status: 401
    - title: "Then I should expect a token"
      expect:
        match:
          key: data.latest
        with:
          object:
            body:
              token:
                any: text
        remember:
          token:
            key: body.token
    - title: "Then I should expect a uid"
      expect:
        match:
          key: data.latest
        with:
          object:
            body:
              uid:
                any: number
        remember:
          uid:
            key: body.uid
  procedures:
    - name: api
      spec:
        either:
          - when:
              is_set:
                key: params.body
            http:
              method:
                keyword: 
                  one_of:
                    - key: params.method
                    - get
              url:
                format: "~s~s"
                params:
                  - one_of:
                      - key: params.baseUrl
                      - key: settings.baseUrl
                  - key: params.path
              headers:
                merge:
                  - key: facts.baseHeaders
                  - object:
                      app:
                        key: facts.app
                  - one_of:
                      - key: params.headers
                      - object: {}
              body:
                key: params.body
            debug:
              one_of:
                - key: params.debug
                - true
          - http:
              method:
                keyword: 
                  one_of:
                    - key: params.method
                    - get
              url:
                format: "~s~s"
                params:
                  - one_of:
                      - key: params.baseUrl
                      - key: settings.baseUrl
                  - key: params.path
              headers:
                merge:
                  - key: facts.baseHeaders
                  - object:
                      app:
                        key: facts.app
                  - one_of:
                      - key: params.headers
                      - object: {}
            debug:
              one_of:
                - key: params.debug
                - true
      as:
        keyword:
          one_of:
            - key: params.as
            - latest
