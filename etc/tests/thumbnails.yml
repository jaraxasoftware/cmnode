version: 1.0
type: test
name: thumbnails
spec:
  config:
    retries: 100
    wait: 5
  procedures:
    - name: info 
      spec:
        http:
          method: post
          url:
            host:
              key: host
              in: settings
            port:
              key: port
              in:
                key: thumbnails
                in: settings
            transport: 
              key: transport
              in:
                key: thumbnails
                in: settings
            path:
              join:
                - key: path
                  in:
                    key: thumbnails
                    in: settings
                - text: "/info"
          headers:
            content-type:
              key: mime
              in: params
            authorization:
              basic-auth:
                key: auth
                in:
                  key: security
                  in: settings
          body:
            key: file
            in: params
      as:
        key: as
        in: params
    - name: combine
      spec:
        http:
          method: post
          url:
            host:
              key: host
              in: settings
            port:
              key: port
              in:
                key: thumbnails
                in: settings
            transport: 
              key: transport
              in:
                key: thumbnails
                in: settings
            path:
              join:
                - key: path
                  in:
                    key: thumbnails
                    in: settings
                - text: "/combine"
          headers:
            authorization:
              basic-auth:
                key: auth
                in:
                  key: security
                  in: settings
          body:
            multipart:
              files:
                key: files
                in: params
      as:
        key: as
        in: params
    - name: convert 
      spec:
        http:
          method: post
          url:
            host:
              key: host
              in: settings
            port:
              key: port
              in:
                key: thumbnails
                in: settings
            transport: 
              key: transport
              in:
                key: thumbnails
                in: settings
            path:
              join:
                - key: path
                  in:
                    key: thumbnails
                    in: settings
                - text: "/convert?type="
                - key: type
                  in: params
          headers:
            content-type:
              key: mime
              in: params
            authorization:
              basic-auth:
                key: auth
                in:
                  key: security
                  in: settings
          body:
            key: file
            in: params
      as:
        key: as
        in: params
    - name: resize
      spec:
        http:
          method: post
          url:
            host:
              key: host
              in: settings
            port:
              key: port
              in:
                key: thumbnails
                in: settings
            transport: 
              key: transport
              in:
                key: thumbnails
                in: settings
            path:
              join:
                - key: path
                  in:
                    key: thumbnails
                    in: settings
                - text: "/convert?type="
                - key: type
                  in: params
                - text: "&width="
                - key: width
                  in: params
                - text: "&height="
                - key: height
                  in: params
          headers:
            content-type:
              key: mime
              in: params
            authorization:
              basic-auth:
                key: auth
                in:
                  key: security
                  in: settings
          body:
            key: file
            in: params
      as:
        key: as
        in: params
    - name: resize_page
      spec:
        http:
          method: post
          url:
            host:
              key: host
              in: settings
            port:
              key: port
              in:
                key: thumbnails
                in: settings
            transport: 
              key: transport
              in:
                key: thumbnails
                in: settings
            path:
              join:
                - key: path
                  in:
                    key: thumbnails
                    in: settings
                - text: "/convert?type="
                - key: type
                  in: params
                - text: "&width="
                - key: width
                  in: params
                - text: "&height="
                - key: height
                  in: params
                - text: "&frame="
                - key: frame 
                  in: params
          headers:
            content-type:
              key: mime
              in: params
            authorization:
              basic-auth:
                key: auth
                in:
                  key: security
                  in: settings
          body:
            key: file
            in: params
      as:
        key: as
        in: params
    - name: convert_page
      spec:
        http:
          method: post
          url:
            host:
              key: host
              in: settings
            port:
              key: port
              in:
                key: thumbnails
                in: settings
            transport: 
              key: transport
              in:
                key: thumbnails
                in: settings
            path:
              join:
                - key: path
                  in:
                    key: thumbnails
                    in: settings
                - text: "/convert?type="
                - key: type
                  in: params
                - text: "&frame="
                - key: frame 
                  in: params
          headers:
            content-type:
              key: mime
              in: params
            authorization:
              basic-auth:
                key: auth
                in:
                  key: security
                  in: settings
          body:
            key: file
            in: params
      as:
        key: as
        in: params
  backgrounds:
    - title: "A sample jpeg file"
      steps:
        - title: "Load sample.jpg from the assets"
          asset: "sample.jpg"
          as: file
    - title: "A sample png file"
      steps:
        - title: "Load sample.png from the assets"
          asset: "sample.png"
          as: file
    - title: "A sample tiff file"
      steps:
        - title: "Load sample.tiff from the assets"
          asset: "sample.tiff"
          as: file
    - title: "A sample pdf file"
      steps:
        - title: "Load sample.pdf from the assets"
          asset: "sample.pdf"
          as: file
    - title: "Another sample pdf file"
      steps:
        - title: "Load sample.pdf from the assets"
          asset: "sample.pdf"
          as: file2
    - title: "A sample gif file"
      steps:
        - title: "Load sample.gif from the assets"
          asset: "sample.gif"
          as: file
    - title: "A transparent, sample gif file"
      steps:
        - title: "Load sample.gif from the assets"
          asset: "transparent-sample.gif"
          as: file
  scenarios:
    - title: "Should convert from JPEG to PNG"
      tags:
        - convert
        - jpeg
        - png
      backgrounds:
        - "A sample jpeg file"
      steps:
        - title: "Convert the file to a png file"
          procedure: convert 
          params:
            object:
              file:
                key: data
                in: 
                  key: file
                  in: data
              mime: "image/jpeg"
              type: "png"
              as: 
                keyword: thumbnail
        - title: "Expect a 200 OK"
          expect:
            eq:
              - number: 200
              - key: status
                in:
                  key: thumbnail
                  in: data
        - title: "Get the info of the converted file"
          procedure: info
          params:
            object:
              file:
                key: body
                in: 
                  key: thumbnail
                  in: data
              mime: "image/png"
              as:
                keyword: thumbnail_data
        - title: "Expect a thumbnail with width equal to 430"
          expect:
            eq:
              - number: 430
              - key: width
                in:
                  key: body
                  in:
                    key: thumbnail_data
                    in: data
        - title: "Expect a thumbnail with height equal to 324"
          expect:
            eq:
              - number: 324
              - key: height
                in:
                  key: body
                  in:
                    key: thumbnail_data
                    in: data
    - title: "Should resize JPEG images"
      tags:
        - thumbnails
        - resize
        - jpeg
      backgrounds:
        - "A sample jpeg file"
      steps:
        - title: "Convert the file to a 200x100 jpeg file"
          procedure: resize 
          params:
            object:
              file:
                key: data
                in: 
                  key: file
                  in: data
              mime: "image/jpeg"
              type: "jpeg"
              width: 200
              height: 100
              as: 
                keyword: thumbnail
        - title: "Get the info of the converted file"
          procedure: info
          params:
            object:
              file:
                key: body
                in: 
                  key: thumbnail
                  in: data
              mime: "image/jpeg"
              as:
                keyword: thumbnail_data
        - title: "Expect a thumbnail of less bytes than the original"
          expect:
            gt:
              - key: size
                in:
                  key: info
                  in: 
                    key: file
                    in: data
              - number:
                  key: "content-length"
                  in: 
                    key: headers
                    in:
                      key: thumbnail_data
                      in: data
        - title: "Expect a thumbnail with width equal to 200"
          expect:
            eq:
              - number: 200
              - key: width
                in:
                  key: body
                  in:
                    key: thumbnail_data
                    in: data
        - title: "Expect a thumbnail with height equal to 151"
          expect:
            eq:
              - number: 151
              - key: height
                in:
                  key: body
                  in:
                    key: thumbnail_data
                    in: data
    
    - title: "Should resize PNG images"
      tags:
        - thumbnails
        - png
        - transparent
      backgrounds:
        - "A sample png file"
      steps:
        - title: "Convert the file to a 200x200 png file"
          procedure: resize
          params:
            object:
              file:
                key: data
                in: 
                  key: file
                  in: data
              mime: "image/png"
              type: "png"
              width: 200
              height: 200
              as: 
                keyword: thumbnail
        - title: "Get the info of the converted file"
          procedure: info
          params:
            object:
              file:
                key: body
                in: 
                  key: thumbnail
                  in: data
              mime: "image/png"
              as:
                keyword: thumbnail_data
        - title: "Expect a thumbnail of less bytes than the original"
          expect:
            gt:
              - key: size
                in:
                  key: info
                  in: 
                    key: file
                    in: data
              - number:
                  key: "content-length"
                  in: 
                    key: headers
                    in:
                      key: thumbnail_data
                      in: data
        - title: "Expect a thumbnail with width equal to 200"
          expect:
            eq:
              - number: 200
              - key: width
                in:
                  key: body
                  in:
                    key: thumbnail_data
                    in: data
        - title: "Expect a thumbnail with height equal to 200"
          expect:
            eq:
              - number: 200
              - key: height
                in:
                  key: body
                  in:
                    key: thumbnail_data
                    in: data
        - title: "Expect a thumbnail with alpha channel"
          expect:
            eq:
              - keyword: true
              - key: hasAlpha
                in:
                  key: body
                  in:
                    key: thumbnail_data
                    in: data
    - title: "Should convert from TIFF to PDF"
      tags:
        - convert
        - tiff
        - pdf
      backgrounds:
        - "A sample tiff file"
      steps:
        - title: "Convert the file to a PDG file"
          procedure: convert
          params:
            object:
              file:
                key: data
                in: 
                  key: file
                  in: data
              mime: "image/tiff"
              type: "pdf"
              as: 
                keyword: thumbnail
        - title: "Verify we got a 200 OK"
          expect:
            eq:
              - number: 200
              - key: status
                in:
                  key: thumbnail
                  in: data
        - title: "Get the info of the converted file"
          procedure: info
          params:
            object:
              file:
                key: body
                in: 
                  key: thumbnail
                  in: data
              mime: "application/pdf"
              as:
                keyword: thumbnail_data

        - title: "Expect a thumbnail with width equal to 612"
          expect:
            eq:
              - number: 612
              - key: width
                in:
                  key: body
                  in:
                    key: thumbnail_data
                    in: data
        - title: "Expect a thumbnail with height equal to 792"
          expect:
            eq:
              - number: 792
              - key: height
                in:
                  key: body
                  in:
                    key: thumbnail_data
                    in: data

    - title: "Should convert and resize from TIFF to PDF"
      tags:
        - thumbnails
        - jpeg
        - tiff
        - pdf
      backgrounds:
        - "A sample tiff file"
      steps:
        - title: "Convert the file to a 300x200 pdf file"
          procedure: resize 
          params:
            object:
              file:
                key: data
                in: 
                  key: file
                  in: data
              mime: "image/tiff"
              type: "pdf"
              width: 300
              height: 200
              as: 
                keyword: thumbnail

        - title: "Get the info of the converted file"
          procedure: info
          params:
            object:
              file:
                key: body
                in: 
                  key: thumbnail
                  in: data
              mime: "application/pdf"
              as:
                keyword: thumbnail_data

        - title: "Expect a file of less bytes than the original"
          expect:
            gt:
              - key: size
                in:
                  key: info
                  in: 
                    key: file
                    in: data
              - number:
                  key: "content-length"
                  in: 
                    key: headers
                    in:
                      key: thumbnail_data
                      in: data

        - title: "Expect a thumbnail with width equal to 155"
          expect:
            eq:
              - number: 155
              - key: width
                in:
                  key: body
                  in:
                    key: thumbnail_data
                    in: data
        - title: "Expect a thumbnail with height equal to 200"
          expect:
            eq:
              - number: 200
              - key: height
                in:
                  key: body
                  in:
                    key: thumbnail_data
                    in: data
    - title: "Should convert a single page from a multipage TIFF, without resizing"
      tags:
        - convert
        - jpeg
        - tiff
        - multipage
      backgrounds:
        - "A sample tiff file"
      steps:
        - title: "Convert the second page of that file to a jpeg file"
          procedure: convert_page
          params:
            object:
              file:
                key: data
                in: 
                  key: file
                  in: data
              mime: "image/tiff"
              type: "jpeg"
              frame: 2
              as: 
                keyword: thumbnail
        - title: "Verify we got a 200 OK"
          expect:
            eq: 
              - number: 200
              - key: status
                in:
                  key: thumbnail
                  in: data 
        - title: "Get the info of the converted file"
          procedure: info
          params:
            object:
              file:
                key: body
                in: 
                  key: thumbnail
                  in: data
              mime: "image/jpeg"
              as:
                keyword: thumbnail_data
        - title: "Expect a thumbnail with width equal to 612"
          expect:
            eq:
              - number: 612
              - key: width
                in:
                  key: body
                  in:
                    key: thumbnail_data
                    in: data
        - title: "Expect a thumbnail with height equal to 792"
          expect:
            eq:
              - number: 792
              - key: height
                in:
                  key: body
                  in:
                    key: thumbnail_data
                    in: data
    - title: "Should extract a single page from a multipage TIFF, without converting or resizing"
      tags:
        - convert
        - tiff
        - multipage
      backgrounds:
        - "A sample tiff file"
      steps:
        - title: "Convert the second page of that file to a TIFF file"
          procedure: convert_page
          params:
            object:
              file:
                key: data
                in: 
                  key: file
                  in: data
              mime: "image/tiff"
              type: "tiff"
              frame: 2
              as: 
                keyword: thumbnail
        - title: "Verify we got a 200 OK"
          expect:
            eq: 
              - number: 200
              - key: status
                in:
                  key: thumbnail
                  in: data 
        - title: "Get the info of the converted file"
          procedure: info
          params:
            object:
              file:
                key: body
                in: 
                  key: thumbnail
                  in: data
              mime: "image/jpeg"
              as:
                keyword: thumbnail_data
        - title: "Expect a thumbnail with width equal to 612"
          expect:
            eq:
              - number: 612
              - key: width
                in:
                  key: body
                  in:
                    key: thumbnail_data
                    in: data
        - title: "Expect a thumbnail with height equal to 792"
          expect:
            eq:
              - number: 792
              - key: height
                in:
                  key: body
                  in:
                    key: thumbnail_data
                    in: data
    - title: "Should extract a single image from a multipage TIFF"
      tags:
        - thumbnails
        - jpeg
        - tiff
        - multipage
      backgrounds:
        - "A sample tiff file"
      steps:
        - title: "Convert the second page of that file to a 300x200 jpeg file"
          procedure: resize_page
          params:
            object:
              file:
                key: data
                in: 
                  key: file
                  in: data
              mime: "image/tiff"
              type: "jpeg"
              frame: 2
              width: 300
              height: 200
              as: 
                keyword: thumbnail

        - title: "Get the info of the converted file"
          procedure: info
          params:
            object:
              file:
                key: body
                in: 
                  key: thumbnail
                  in: data
              mime: "image/jpeg"
              as:
                keyword: thumbnail_data

        - title: "Expect a file of less bytes than the original"
          expect:
            gt:
              - key: size
                in:
                  key: info
                  in: 
                    key: file
                    in: data
              - number:
                  key: "content-length"
                  in: 
                    key: headers
                    in:
                      key: thumbnail_data
                      in: data

        - title: "Expect a thumbnail with width equal to 300"
          expect:
            eq:
              - number: 300
              - key: width
                in:
                  key: body
                  in:
                    key: thumbnail_data
                    in: data
        - title: "Expect a thumbnail with height equal to 388"
          expect:
            eq:
              - number: 388
              - key: height
                in:
                  key: body
                  in:
                    key: thumbnail_data
                    in: data
    
    - title: "Should extract a single image from a multipage PDF"
      tags:
        - thumbnails
        - jpeg
        - pdf
        - multipage
      backgrounds:
        - "A sample pdf file"
      steps:
        - title: "Convert the second page of that file to a 300x200 jpeg file"
          procedure: resize_page 
          params:
            object:
              file:
                key: data
                in: 
                  key: file
                  in: data
              mime: "application/pdf"
              type: "jpeg"
              frame: 2
              width: 300
              height: 200
              as: 
                keyword: thumbnail

        - title: "Get the info of the converted file"
          procedure: info
          params:
            object:
              file:
                key: body
                in: 
                  key: thumbnail
                  in: data
              mime: "image/jpeg"
              as:
                keyword: thumbnail_data

        - title: "Expect a file of less bytes than the original"
          expect:
            gt:
              - key: size
                in:
                  key: info
                  in: 
                    key: file
                    in: data
              - number:
                  key: "content-length"
                  in: 
                    key: headers
                    in:
                      key: thumbnail_data
                      in: data

        - title: "Expect a thumbnail with width equal to 259"
          expect:
            eq:
              - number: 259
              - key: width
                in:
                  key: body
                  in:
                    key: thumbnail_data
                    in: data

        - title: "Expect a thumbnail with height equal to 200"
          expect:
            eq:
              - number: 200
              - key: height
                in:
                  key: body
                  in:
                    key: thumbnail_data
                    in: data
    - title: "Should convert from PDF to TIFF"
      tags:
        - thumbnails
        - jpeg
        - tiff
        - pdf
      backgrounds:
        - "A sample pdf file"
      steps:
        - title: "Convert the file to a 300x200 tiff file"
          procedure: resize
          params:
            object:
              file:
                key: data
                in: 
                  key: file
                  in: data
              mime: "application/pdf"
              type: "tiff"
              width: 300
              height: 200
              as: 
                keyword: thumbnail

        - title: "Get the info of the converted file"
          procedure: info
          params:
            object:
              file:
                key: body
                in: 
                  key: thumbnail
                  in: data
              mime: "image/tiff"
              as:
                keyword: thumbnail_data

        - title: "Expect a thumbnail with width equal to 259"
          expect:
            eq:
              - number: 259
              - key: width
                in:
                  key: body
                  in:
                    key: thumbnail_data
                    in: data
        - title: "Expect a thumbnail with height equal to 200"
          expect:
            eq:
              - number: 200
              - key: height
                in:
                  key: body
                  in:
                    key: thumbnail_data
                    in: data
    - title: "Should convert GIF to GIF"
      tags:
        - gif
        - convert
      backgrounds:
        - "A sample gif file"
      steps:
        - title: "Convert the file to a GIF file"
          procedure: convert
          params:
            object:
              file:
                key: data
                in: 
                  key: file
                  in: data
              mime: "image/gif"
              type: "gif"
              as: 
                keyword: thumbnail
        - title: "Verify we got a 200 OK"
          expect:
            eq:
              - number: 200
              - key: status
                in: 
                  key: thumbnail
                  in: data
        - title: "Get the info of the converted file"
          procedure: info
          params:
            object:
              file:
                key: body
                in: 
                  key: thumbnail
                  in: data
              mime: "image/gif"
              as:
                keyword: thumbnail_data

        - title: "Expect a thumbnail with width equal to 260"
          expect:
            eq:
              - number: 260
              - key: width
                in:
                  key: body
                  in:
                    key: thumbnail_data
                    in: data
        - title: "Expect a thumbnail with height equal to 208"
          expect:
            eq:
              - number: 208
              - key: height
                in:
                  key: body
                  in:
                    key: thumbnail_data
                    in: data
    - title: "Should not enlarge GIFs"
      tags:
        - thumbnails
        - jpeg
        - gif
        - enlarge
      backgrounds:
        - "A sample gif file"
      steps:
        - title: "Convert the file to a 600x600 gif file"
          procedure: resize 
          params:
            object:
              file:
                key: data
                in: 
                  key: file
                  in: data
              mime: "image/gif"
              type: "gif"
              width: 600
              height: 600
              as: 
                keyword: thumbnail

        - title: "Get the info of the converted file"
          procedure: info
          params:
            object:
              file:
                key: body
                in: 
                  key: thumbnail
                  in: data
              mime: "image/gif"
              as:
                keyword: thumbnail_data

        - title: "Expect a thumbnail with width equal to 260"
          expect:
            eq:
              - number: 260
              - key: width
                in:
                  key: body
                  in:
                    key: thumbnail_data
                    in: data
        - title: "Expect a thumbnail with height equal to 208"
          expect:
            eq:
              - number: 208
              - key: height
                in:
                  key: body
                  in:
                    key: thumbnail_data
                    in: data
    
    - title: "Should resize transparent GIFs"
      tags:
        - thumbnails
        - jpeg
        - gif
        - transparent
      backgrounds:
        - "A transparent, sample gif file"
      steps:
        - title: "Convert the file to a 100x100 gif file"
          procedure: resize 
          params:
            object:
              file:
                key: data
                in: 
                  key: file
                  in: data
              mime: "image/gif"
              type: "gif"
              width: 100
              height: 100
              as: 
                keyword: thumbnail

        - title: "Get the info of the converted file"
          procedure: info
          params:
            object:
              file:
                key: body
                in: 
                  key: thumbnail
                  in: data
              mime: "image/gif"
              as:
                keyword: thumbnail_data

        - title: "Expect a thumbnail with width equal to 100"
          expect:
            eq:
              - number: 100
              - key: width
                in:
                  key: body
                  in:
                    key: thumbnail_data
                    in: data
        - title: "Expect a thumbnail with height equal to 59"
          expect:
            eq:
              - number: 59
              - key: height
                in:
                  key: body
                  in:
                    key: thumbnail_data
                    in: data
        
        - title: "Expect a thumbnail with alpha channel"
          expect:
            eq:
              - keyword: true
              - key: hasAlpha
                in:
                  key: body
                  in:
                    key: thumbnail_data
                    in: data
    
              
    - title: "Should convert HTML to PDF"
      tags:
        - thumbnails
        - html
        - pdf
      steps:
        - title: "Convert an html document to a 300x300 pdf file"
          procedure: resize 
          params:
            object:
              file:
                text:
                  literal: "<html><head><title>A sample HTML page</title></head><body><h1>Hello</h1><p>World</p></body></html>"
              mime: "text/html"
              type: "pdf"
              width: 300
              height: 300
              as: 
                keyword: thumbnail

        - title: "Get the info of the converted file"
          procedure: info
          params:
            object:
              file:
                key: body
                in: 
                  key: thumbnail
                  in: data
              mime: "application/pdf"
              as:
                keyword: thumbnail_data
        
        - title: "Expect a thumbnail with width equal to 212"
          expect:
            eq:
              - number: 212
              - key: width
                in:
                  key: body
                  in:
                    key: thumbnail_data
                    in: data

        - title: "Expect a thumbnail with height equal to 300"
          expect:
            eq:
              - number: 300
              - key: height
                in:
                  key: body
                  in:
                    key: thumbnail_data
                    in: data
    
              
    - title: "Should combine PDFs"
      tags:
        - pdf
        - combine
      backgrounds:
        - "A sample pdf file"
        - "Another sample pdf file"
      steps:
        - title: "Combine both PDF files"
          procedure: combine
          params:
            object:
              files:
                list:
                  - object:
                      mime: "application/pdf"
                      name: "file"
                      filename: "file1.pdf"
                      data: 
                        key: data
                        in: 
                          key: file
                          in: data
                  - object:
                      mime: "application/pdf"
                      name: "file"
                      filename: "file2.pdf"
                      data: 
                        key: data
                        in: 
                          key: file2
                          in: data
              as: 
                keyword: combined

        - title: "Get the info of the combined file"
          procedure: info
          params:
            object:
              file:
                key: body
                in: 
                  key: combined
                  in: data
              mime: "application/pdf"
              as:
                keyword: combined_data
        
        - title: "Expect a thumbnail with width equal to 594"
          expect:
            eq:
              - number: 594
              - key: width
                in:
                  key: body
                  in:
                    key: combined_data
                    in: data

        - title: "Expect a thumbnail with height equal to 459"
          expect:
            eq:
              - number: 459
              - key: height
                in:
                  key: body
                  in:
                    key: combined_data
                    in: data
