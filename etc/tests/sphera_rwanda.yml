version: 1.0
type: test 
name: sphera_rwanda
spec:
  config:
    retries: 4
    wait: 1000
  procedures:
    - name: collab_connection
      spec:
        connect:
          host: 
            key: host
            in: settings 
          port:
            key: port
            in:
              key: collab
              in:
                key: sphera-rwanda
                in: settings
          path:
            join:
              terms:
                - key: path
                  in: 
                    key: collab
                    in: 
                      key: sphera-rwanda
                      in: settings
                - text:
                    literal: "/_api/ws"
          transport:
            key: transport
            in:
              key: collab
              in:
                key: sphera-rwanda
                in: settings
        as:
          key: name
          in: params
        protocol:
          spec:
            decoders:
              ping:
                object:
                  cmd: "ping"
                  tid:
                    any: number
            update:
              ping:
                model:
                  tid:
                    key: tid
                cmds:
                  - effect: reply
                    encoder: pong
            encoders:
              pong:
                object:
                  result: "ok"
                  tid:
                    key: tid
  steps:
    - title: "I use Doctor1's connection"
      merge:
        - key: data
        - object:
            current_conn:
              keyword: doctor1
    - title: "A collab connection for Doctor1"
      procedure: collab_connection
      params:
        object:
          name:
            keyword: doctor1
    - title: "Ensure Doctor1's connection is up"
      probe:
        connection: 
          keyword: doctor1
        status: up
    - title: "Login as Doctor1"
      send:
        to: 
          key: current_conn
          in: data
        spec:
          object:
            cmd: "sphera/collab/login"
            tid: 1
            data:
              object:
                user_id: "doctor1@rwanda.sphera"
                password: "1234"
    - title: "Launch notifications"
      send:
        to: 
          key: current_conn
          in: data
        spec:
          object:
            cmd: "sphera/collab/launch_notifications"
            tid:
              sum:
                - number: 1
                - key: last_ack
                  in: data
            data: {}
    - title: "Launch media notifications"
      send:
        to: 
          key: current_conn
          in: data
        spec:
          object:
            cmd: "sphera/collab/media/launch_notifications"
            tid:
              sum:
                - number: 1
                - key: last_ack
                  in: data
            data: {}
    - title: "Expect an ack"
      receive:
        from: 
          key: current_conn
          in: data
        spec:
          object:
            ack:
              any: number
        remember:
          last_ack:
            key: ack
    - title: "Expect an ok"
      receive:
        from: 
          key: current_conn
          in: data
        spec:
          object:
            result: 
              text: "ok"
            tid:
              any: number
    - title: "Expect an invalid role error"
      receive:
        from: 
          key: current_conn
          in: data
        spec:
          object:
            result: 
              text: "error"
            data:
              object:
                code: "role_invalid"
    - title: "Start a chat session"
      send:
        to: 
          key: current_conn
          in: data
        spec:
          object:
            cmd: "sphera/collab/start_session"
            tid:
              sum:
                - number: 1
                - key: last_ack
                  in: data
            data: {}
    - title: "Expect a chat session id"
      receive:
        from: 
          key: current_conn
          in: data
        spec:
          object:
            result: 
              text: "ok"
            tid:
              any: number
            data:
              object:
                session_id:
                  text:
                    regexp: "chat.session-"
    - title: "Expect a session id"
      receive:
        from: 
          key: current_conn
          in: data
        spec:
          object:
            result: 
              text: "ok"
            tid:
              any: number
            data:
              object:
                session_id:
                  any: text
    - title: "I try to create an encounter using the collab"
      send:
        to: 
          key: current_conn
          in: data
        spec:
          object:
            cmd: "sphera/collab/create_encounter"
            tid:
              sum:
                - number: 1
                - key: last_ack
                  in: data
            data:
              object:
                patient_id:
                  key: patient_id
                  in: data
                location_id: "/sphera/rwanda/locations/test"
                speciality:  "/sphera/rwanda/collab/med.specialities/pediatrics"
                patient_info:
                  object:
                    type: "sphera_shp_1"
                    data:
                      object:
                        medical_questionary:
                          object:
                            data: "a value"
                    text: "some text"
    - title: "Expect an encounter id"
      receive:
        from: 
          key: current_conn
          in: data
        spec:
          object:
            event: "sphera/collab/new_message"
            data:
              object:
                body:
                  encounter_id:
                    any: text
        remember:
          encounter_id:
            key: encounter_id
            in: 
              key: body
              in: data
    - title: "Set the doctor for the encounter"
      send:
        to: 
          key: current_conn
          in: data
        spec:
          object:
            cmd: "sphera/collab/set_encounter_doctor"
            tid:
              sum:
                - number: 1
                - key: last_ack
                  in: data
            data:
              object:
                encounter_id:
                  key: encounter_id
                  in: data
    - title: "Add a report to the encounter"
      send:
        to: 
          key: current_conn
          in: data
        spec:
          object:
            cmd: "sphera/collab/add_encounter_report"
            tid:
              sum:
                - number: 1
                - key: last_ack
                  in: data
            data:
              object:
                encounter_id:
                  key: encounter_id
                  in: data
                report_info:
                  object:
                    report: "this is a test"
                    extra_field: "an extra field"
    - title: "Confirm the encounter"
      send:
        to: 
          key: current_conn
          in: data
        spec:
          object:
            cmd: "sphera/collab/save_encounter_report"
            tid:
              sum:
                - number: 1
                - key: last_ack
                  in: data
            data:
              object:
                encounter_id:
                  key: encounter_id
                  in: data
                confirmed: true
                report_info:
                  object:
                    message: "this is a testi (confirmed)"
    - title: "Expect an assigned encounter"
      receive:
        from: 
          key: current_conn
          in: data
        spec:
          object:
            event: "sphera/collab/new_message"
            data:
              object:
                conversation_id:
                  any: text
                session_id:
                  any: text
                text: "doctor assigned"
    - title: "Expect a resolved encounter"
      receive:
        from: 
          key: current_conn
          in: data
        spec:
          object:
            event: "sphera/collab/updated_status"
            data:
              object:
                conversation_id:
                  any: text
                session_id:
                  any: text
                status: "resolved"
    - title: "Expect an updated message for that encounter"
      receive:
        from: 
          key: current_conn
          in: data
        spec:
          object:
            event: "sphera/collab/updated_message"
            data:
              object:
                body:
                  encounter_id:
                    key: encounter_id
                    in: data
                text: "encounter capture"
  backgrounds:
    - title: "I have a chat session"
      steps:
        - ref: "Start a chat session"
        - ref: "Expect an ack"
        - ref: "Expect an ok"
        - ref: "Expect a chat session id"
    - title: "I turn on chat notifications"
      steps:
        - ref: "Launch notifications"
        - ref: "Expect an ack"
        - ref: "Expect an ok"
    - title: "I turn on media notifications"
      steps:
        - ref: "Launch media notifications"
        - ref: "Expect an ack"
        - ref: "Expect an ok"
    - title: "A collab connection for a doctor"
      steps:
        - ref: "A collab connection for Doctor1"
        - ref: "Ensure Doctor1's connection is up"
        - ref: "I use Doctor1's connection"
    - title: "I am logged in as a doctor on the collab"
      steps:
        - ref: "Login as Doctor1"
        - ref: "Expect an ack" 
        - ref: "Expect a session id"
    - title: "Assign that encounter to me"
      steps:
        - ref: "Set the doctor for the encounter"
        - ref: "Expect an ack"
        - ref: "Expect an ok"
    - title: "I added a new report to the encounter"
      steps:
        - ref: "Add a report to the encounter"
        - ref: "Expect an ack"
        - ref: "Expect an ok"
    - title: "I confirmed the encounter"
      steps:
        - ref: "Confirm the encounter"
        - ref: "Expect an ack"
        - ref: "Expect an ok"
    - title: "Sphera SHP api is online"
      steps:
        - title: "Connect to the Sphera SHP http api"
          connect:
            host: 
              key: host
              in: settings 
            port: 443
            path:
              join:
                terms:
                  - key: path
                    in: 
                      key: shp
                      in: 
                        key: sphera-rwanda
                        in: settings
                  - text:
                      literal: "/_api"
            transport: https
          as: shp_api
        - title: "Check shp returned 400"
          probe:
            connection: shp_api
            status: up
    - title: "I am logged in as admin" 
      steps:
        - title: "Login as admin"
          send:
            to: shp_api
            spec:
              object:
                headers:
                  object:
                    content-type: 
                      text:
                        literal: "application/json"
                body:
                  object:
                    cmd:
                      text:
                        literal: "sphera/shp/get_token"
                    data:
                      object:
                        id: "admin"
                        password: "netcomposer"
        - title: "Check we got a token"
          receive:
            from: shp_api       
            spec:
              object:
                status: 200
                body:
                  object:
                    data:
                      object:
                        token_id:
                          any: text
            remember:
              token:
                key: token_id
                in: 
                  key: data
                  in: body
    - title: "I am logged in as a doctor"
      steps:
        - title: "Login as doctor"
          send:
            to: shp_api
            spec:
              object:
                headers:
                  object:
                    content-type: 
                      text:
                        literal: "application/json"
                body:
                  object:
                    cmd:
                      text:
                        literal: "sphera/shp/get_token"
                    data:
                      object:
                        id:
                          text:
                            literal: "doctor1@rwanda.sphera"
                        password:
                          text:
                            literal: "1234"
                        device:
                          text:
                            literal: "device1"
                        domain_id:
                          text:
                            literal: "sphera/rwanda"
        - title: "Check we got a token"
          receive:
            from: shp_api       
            spec:
              object:
                status: 200
                body:
                  object:
                    data:
                      object:
                        token_id:
                          any: text
            remember:
              token:
                key: token_id
                in: 
                  key: data
                  in: body
    - title: "I am logged in as an operator"
      steps:
        - title: "Login as an operator"
          send:
            to: shp_api
            spec:
              object:
                headers:
                  object:
                    content-type: 
                      text:
                        literal: "application/json"
                body:
                  object:
                    cmd:
                      text:
                        literal: "sphera/shp/get_token"
                    data:
                      object:
                        id: "operator1@rwanda.sphera"
                        password: "1234"
                        device: "device1"
                        domain_id: "sphera/rwanda"
        - title: "Check we got a token"
          receive:
            from: shp_api       
            spec:
              object:
                status: 200
                body:
                  object:
                    data:
                      object:
                        token_id:
                          any: text
            remember:
              token:
                key: token_id
                in: 
                  key: data
                  in: body
    - title: "There are no objects of type consent"
      steps:
        - title: "Unload all objects under /sphera"
          send:
            to: shp_api
            spec:
              object:
                headers:
                  object:
                    x-netcomposer-auth:
                      key: token
                      in: data
                    content-type: 
                      text:
                        literal: "application/json"
                body:
                  object:
                    cmd: "objects/domain/unload_childs"
                    data:
                      object:
                        id: "/sphera/rwanda"
        - title: "Check we got an ok"
          receive:
            from: shp_api       
            spec:
              object:
                status: 200
                body:
                  result: "ok"
        - title: "Delete all consents"
          send:
            to: shp_api
            spec:
              object:
                headers:
                  object:
                    x-netcomposer-auth:
                      key: token
                      in: data
                    content-type: 
                      text:
                        literal: "application/json"
                body:
                  object:
                    cmd: "objects/domain/delete_childs_of_type"
                    data:
                      object:
                        id: "/sphera/rwanda"
                        type: "med.consent"
        - title: "Check we got an ok"
          receive:
            from: shp_api       
            spec:
              object:
                status: 200
    - title: "There are no objects of type operator"
      steps:
        - title: "Delete all operators"
          send:
            to: shp_api
            spec:
              object:
                headers:
                  object:
                    x-netcomposer-auth:
                      key: token
                      in: data
                    content-type: 
                      text:
                        literal: "application/json"
                body:
                  object:
                    cmd: "objects/domain/delete_childs_of_type"
                    data:
                      object:
                        id: "/sphera/rwanda"
                        type: "med.operator"
        - title: "Check we got an ok"
          receive:
            from: shp_api       
            spec:
              object:
                status: 200
    - title: "There is an operator"
      steps:
        - title: "Add the operator role to user operator1"
          send:
            to: shp_api
            spec:
              object:
                headers:
                  object:
                    x-netcomposer-auth:
                      key: token
                      in: data
                    content-type: 
                      text:
                        literal: "application/json"
                body:
                  object:
                    cmd: "objects/domain/create_link"
                    data:
                      object:
                        from: "/sphera/rwanda/collab/med.operators/operator1"
                        to_parent: "/sphera/rwanda/collab/users/operator1"
        - title: "Check we got an ok"
          receive:
            from: shp_api       
            spec:
              object:
                status: 200
    - title: "There are no patients"
      steps:
        - title: "Unload all objects under /sphera"
          send:
            to: shp_api
            spec:
              object:
                headers:
                  object:
                    x-netcomposer-auth:
                      key: token
                      in: data
                    content-type: 
                      text:
                        literal: "application/json"
                body:
                  object:
                    cmd: "objects/domain/unload_childs"
                    data:
                      object:
                        id: "/sphera/rwanda"
        - title: "Check we got an ok"
          receive:
            from: shp_api       
            spec:
              object:
                status: 200
                body:
                  result: "ok"
        - title: "Delete all patients"
          send:
            to: shp_api
            spec:
              object:
                headers:
                  object:
                    x-netcomposer-auth:
                      key: token
                      in: data
                    content-type: 
                      text:
                        literal: "application/json"
                body:
                  object:
                    cmd: "objects/domain/delete_childs_of_type"
                    data:
                      object:
                        id: "/sphera/rwanda"
                        type: "med.patient"
        - title: "Check we got an ok"
          receive:
            from: shp_api       
            spec:
              object:
                status: 200
    - title: "There are no conversations"
      steps:
        - title: "Unload all objects under /sphera"
          send:
            to: shp_api
            spec:
              object:
                headers:
                  object:
                    x-netcomposer-auth:
                      key: token
                      in: data
                    content-type: 
                      text:
                        literal: "application/json"
                body:
                  object:
                    cmd: "objects/domain/unload_childs"
                    data:
                      object:
                        id: "/sphera/rwanda"
        - title: "Check we got an ok"
          receive:
            from: shp_api       
            spec:
              object:
                status: 200
                body:
                  result: "ok"
        - title: "Delete all conversations"
          send:
            to: shp_api
            spec:
              object:
                headers:
                  object:
                    x-netcomposer-auth:
                      key: token
                      in: data
                    content-type: 
                      text:
                        literal: "application/json"
                body:
                  object:
                    cmd: "objects/domain/delete_childs_of_type"
                    data:
                      object:
                        id: "/sphera/rwanda"
                        type: "conversation"
    - title: "There are no tokens"
      steps:
        - title: "Unload all objects under /sphera"
          send:
            to: shp_api
            spec:
              object:
                headers:
                  object:
                    x-netcomposer-auth:
                      key: token
                      in: data
                    content-type: 
                      text:
                        literal: "application/json"
                body:
                  object:
                    cmd: "objects/domain/unload_childs"
                    data:
                      object:
                        id: "/sphera/rwanda"
        - title: "Check we got an ok"
          receive:
            from: shp_api       
            spec:
              object:
                status: 200
                body:
                  result: "ok"
        - title: "Delete all collab tokens"
          send:
            to: shp_api
            spec:
              object:
                headers:
                  object:
                    x-netcomposer-auth:
                      key: token
                      in: data
                    content-type: 
                      text:
                        literal: "application/json"
                body:
                  object:
                    cmd: "objects/domain/delete_childs_of_type"
                    data:
                      object:
                        id: "/sphera/rwanda/collab/tokens"
                        type: "token"
        - title: "Delete all other tokens"
          send:
            to: shp_api
            spec:
              object:
                headers:
                  object:
                    x-netcomposer-auth:
                      key: token
                      in: data
                    content-type: 
                      text:
                        literal: "application/json"
                body:
                  object:
                    cmd: "objects/domain/delete_childs_of_type"
                    data:
                      object:
                        id: "/tokens"
                        type: "token"
    - title: "There are no messages"
      steps:
        - title: "Unload all objects under /sphera"
          send:
            to: shp_api
            spec:
              object:
                headers:
                  object:
                    x-netcomposer-auth:
                      key: token
                      in: data
                    content-type: 
                      text:
                        literal: "application/json"
                body:
                  object:
                    cmd: "objects/domain/unload_childs"
                    data:
                      object:
                        id: "/sphera/rwanda"
        - title: "Check we got an ok"
          receive:
            from: shp_api       
            spec:
              object:
                status: 200
                body:
                  result: "ok"
        - title: "Delete all messages"
          send:
            to: shp_api
            spec:
              object:
                headers:
                  object:
                    x-netcomposer-auth:
                      key: token
                      in: data
                    content-type: 
                      text:
                        literal: "application/json"
                body:
                  object:
                    cmd: "objects/domain/delete_childs_of_type"
                    data:
                      object:
                        id: "/sphera/rwanda/collab/messages"
                        type: "message"
    - title: "There are no encounters"
      steps:
        - title: "Unload all objects under /sphera"
          send:
            to: shp_api
            spec:
              object:
                headers:
                  object:
                    x-netcomposer-auth:
                      key: token
                      in: data
                    content-type: 
                      text:
                        literal: "application/json"
                body:
                  object:
                    cmd: "objects/domain/unload_childs"
                    data:
                      object:
                        id: "/sphera/rwanda"
        - title: "Check we got an ok"
          receive:
            from: shp_api       
            spec:
              object:
                status: 200
                body:
                  result: "ok"
        - title: "Delete all encounters"
          send:
            to: shp_api
            spec:
              object:
                headers:
                  object:
                    x-netcomposer-auth:
                      key: token
                      in: data
                    content-type: 
                      text:
                        literal: "application/json"
                body:
                  object:
                    cmd: "objects/domain/delete_childs_of_type"
                    data:
                      object:
                        id: "/sphera/rwanda"
                        type: "med.encounter"
        - title: "Check we got an ok"
          receive:
            from: shp_api       
            spec:
              object:
                status: 200
    - title: "Default channels are present"
      steps:
        - title: "Create default channels for Rwanda"
          send:
            to: shp_api
            spec:
              object:
                headers:
                  content-type: "application/json"
                  x-netcomposer-auth:
                    key: token
                    in: data
                body:
                  object:
                    cmd: "objects/node/load_objs"
                    data:
                      object:
                        objs:
                          list:
                            - object:
                                path: "/sphera/rwanda/collab/conversations/inbox"
                                name: "inbox"
                                conversation:
                                  object:
                                    type: med.capture
                            - object:
                                path: "/sphera/rwanda/collab/conversations/general"
                                name: "general"
                                conversation:
                                  object:
                                    type: channel
                            - object:
                                path: "/sphera/rwanda/collab/conversations/kfh"
                                name: "KFH"
                                conversation:
                                  object:
                                    type: channel
                            - object:
                                path: "/sphera/rwanda/collab/conversations/pediatria"
                                name: "paediatrics"
                                conversation:
                                  object:
                                    type: channel
                            - object:
                                path: "/sphera/rwanda/collab/med.specialities/pediatrics"
                                name: "Pediatrics"
                                med.speciality: 
                                  object:
                                    capture_conversation_ids: 
                                      list:
                                        - "/sphera/rwanda/collab/conversations/inbox"
                            
        - title: "Check we got an ok"
          receive:
            from: shp_api       
            spec:
              object:
                status: 200

    - title: "There is a patient"
      steps:
        - title: "Create a patient 9000 with initials ABC"
          send:
            to: shp_api
            spec:
              object:
                headers:
                  content-type: "application/json"
                  x-netcomposer-auth:
                    key: token
                    in: data
                body:
                  object:
                    cmd: "objects/domain/create_child"
                    data:
                      object:
                        path: "/sphera/rwanda/collab/med.patients/patient9000"
                        data:
                          object:
                            med.patient:
                              name: "Patient9000"
                              surname: "Doe"
                              birth_day: 2
                              birth_month: 2
                              birth_year: 2000
                              gender: "M"
                              search_words: "doe"
                              special_ids:
                                list:
                                  - object:
                                      type: "sphera"
                                      id: 9000
                                      meta:
                                        initials: "ABC"
        
        - title: "Verify we got a patient id"
          receive:
            from: shp_api       
            spec:
              object:
                status: 200
                body:
                  object:
                    data:
                      object:
                        id:
                          any: text
            remember:
              patient_id:
                key: id
                in: 
                  key: data
                  in: body
    - title: "Get empty data for patient 9000"
      steps:
        - title: "Try to find a patient"
          send:
            to: shp_api
            spec:
              object:
                headers:
                  content-type: "application/json"
                  x-netcomposer-auth:
                    key: token
                    in: data
                body:
                  object:
                    cmd: "sphera/shp/find_patient"
                    data:
                      object:
                        patient_id: "9000"
                        initials: "ABC"

        - title: "Check we got patient data"
          receive:
            from: shp_api       
            spec:
              object:
                status: 200
                body:
                  object:
                    result: "ok"
                    data:
                      object:
                        data:
                          list: empty
    - title: "There is a consent"
      steps:
        - title: "Create a consent"
          send:
            to: shp_api
            spec:
              object:
                headers:
                  content-type: "application/json"
                  x-netcomposer-auth:
                    key: token
                    in: data
                body:
                  object:
                    cmd: "objects/domain/create_child"
                    data:
                      object:
                        path: "/sphera/rwanda/collab/med.consents/consent2000"
                        data:
                          object:
                            med.consent:
                              consent_text: "My test consent"
        
        - title: "Verify we got a consent id"
          receive:
            from: shp_api       
            spec:
              object:
                status: 200
                body:
                  object:
                    data:
                      object:
                        id:
                          any: text
            remember:
              consent:
                key: id
                in: 
                  key: data
                  in: body

    - title: "There is a default consent"
      steps:
        - title: "Create a consent"
          send:
            to: shp_api
            spec:
              object:
                headers:
                  content-type: "application/json"
                  x-netcomposer-auth:
                    key: token
                    in: data
                body:
                  object:
                    cmd: "objects/domain/create_child"
                    data:
                      object:
                        path: "/sphera/rwanda/collab/med.consents/consent1"
                        data:
                          object:
                            med.consent:
                              consent_text: "My test consent"
        
        - title: "Verify we got a consent id"
          receive:
            from: shp_api       
            spec:
              object:
                status: 200
                body:
                  object:
                    data:
                      object:
                        id:
                          any: text
            remember:
              consent:
                key: id
                in: 
                  key: data
                  in: body

    - title: "Get last consent returns a consent error"
      steps:
        - title: "Get the last consent"
          send:
            to: shp_api
            spec:
              object:
                headers:
                  content-type: "application/json"
                  x-netcomposer-auth:
                    key: token
                    in: data
                body:
                  object:
                    cmd:
                      text:
                        literal: "sphera/shp/get_consent"
        - title: "Check we got a consent error"
          receive:
            from: shp_api       
            spec:
              object:
                status: 200
                body:
                  object:
                    data:
                      object:
                        code: "consent_error"
    - title: "Get last consent returns the consent data"
      steps:
        - title: "Get the last consent"
          send:
            to: shp_api
            spec:
              object:
                headers:
                  content-type: "application/json"
                  x-netcomposer-auth:
                    key: token
                    in: data
                body:
                  object:
                    cmd: "sphera/shp/get_consent"
        - title: "Check we got the consent data"
          receive:
            from: shp_api       
            spec:
              object:
                status: 200
                body:
                  object:
                    data:
                      object:
                        consent_id:
                          any: text
                        consent_text:
                          any: text
                        is_signed:
                          any: keyword
            remember:
              consent:
                key: data
                in: body

    - title: "The consent is signed"
      steps:
        - title: "Set the consent as signed"
          send:
            to: shp_api
            spec:
              object:
                headers:
                  content-type: "application/json"
                  x-netcomposer-auth:
                    key: token
                    in: data
                body:
                  object:
                    cmd: "sphera/shp/set_consent"
                    data:
                      object:
                        consent_id:
                          key: consent
                          in: data
                        is_signed:
                          keyword: true

        - title: "Check we got an ok"
          receive:
            from: shp_api       
            spec:
              object:
                status: 200
                body:
                  object:
                    result: "ok"

    - title: "A new encounter" 
      steps:
        - title: "Create an encounter for patient 9000 in pediatrics"
          send:
            to: shp_api
            spec:
              object:
                headers:
                  content-type: "application/json"
                  x-netcomposer-auth:
                    key: token
                    in: data
                body:
                  object:
                    cmd: "sphera/shp/create_encounter"
                    data:
                      object:
                        patient_id: "9000"
                        speciality:  "/sphera/brazil/collab/med.specialities/pediatrics"
                        patient_info:
                          object:
                            type: "sphera_shp_1"
                            data:
                              object:
                                medical_questionary:
                                  object:
                                    data: "a value"
                            text: "some text"

        - title: "Verify I got an encounter and a conversation"
          receive:
            from: shp_api
            spec:
              object:
                status: 200
                body:
                  object:
                    result: "ok"
                    data:
                      object:
                        encounter_id: 
                          any: text
                        conversation:
                          any: text
            remember:
              encounter_id:
                key: encounter_id
                in:
                  key: data
                  in: body
              conversation:
                key: conversation
                in:
                  key: data
                  in: body

    - title: "There is a report for that encounter"
      steps:
        - title: "Find reports"
          send:
            to: shp_api
            spec:
              object:
                headers:
                  x-netcomposer-auth:
                    key: token
                    in: data
                  content-type: "application/json"
                body:
                  object:
                    cmd: "sphera/shp/find_reports"

        - title: "Verify I got a report"
          receive:
            from: shp_api
            spec:
              object:
                status: 200
                body:
                  object:
                    data:
                      list:
                        - object:
                            reports:
                              list:
                                - object:
                                    text:
                                      any: text
    - title: "Medical data uploaded for that encounter"
      steps:
        - title: "Upload medical data with a equal to 1"
          send:
            to: shp_api
            spec:
              object:
                headers:
                  x-netcomposer-auth:
                    key: token
                    in: data
                  content-type: "application/json"
                body:
                  object:
                    cmd: "sphera/shp/upload_medical_data"
                    data:
                      object:
                        encounter_id:
                          key: encounter_id
                          in: data
                        data:
                          object:
                            a: 1

        - title: "Verify I got the encounter id back"
          receive:
            from: shp_api
            spec:
              object:
                status: 200
                body:
                  object:
                    result: "ok"
                    data:
                      object:
                        data:
                          object:
                            encounter_id:
                              any: text
    - title: "That encounter file upload api for name file.txt"
      steps:
        - title: "Setup the encounter file upload api"
          connect:
            host: 
              key: host
              in: settings 
            port: 443
            path:
              join:
                terms:
                  - key: path
                    in: 
                      key: shp
                      in:
                        key: sphera-rwanda
                        in: settings
                  - text: 
                      literal: "/encounter/"
                  - key: encounter_id
                    in: data
                  - text:
                      literal: "/_file?name=file.txt"
            transport: https
          as: encounter_file_api
        - title: "Check the encounter file api returned 400"
          probe:
            connection: encounter_file_api
            status: up
  scenarios:
    - title: "Obtain a token as a valid user"
      tags: 
        - shp
        - sphera 
        - rwanda
        - token
      backgrounds:
        - "Sphera SHP api is online"
        - "I am logged in as a doctor"
      steps:  []
    - title: "Obtain a token as an unknown user"
      tags: 
        - shp
        - sphera 
        - rwanda
        - token
      backgrounds:
        - "Sphera SHP api is online"
      steps: 
        - title: "Ask for a token"
          send:
            to: shp_api
            spec:
              object:
                headers:
                  object:
                    content-type: 
                      text:
                        literal: "application/json"
                body:
                  object:
                    cmd:
                      text:
                        literal: "sphera/shp/get_token"
                    data:
                      object:
                        id:
                          text:
                            literal: "unknown@rwanda.sphera"
                        password:
                          text:
                            literal: "1234"
                        device:
                          text:
                            literal: "device1"
                        domain_id:
                          text:
                            literal: "sphera/rwanda"
        - title: "Check we got a user_not_found error"
          receive:
            from: shp_api       
            spec:
              object:
                status: 200
                body:
                  object:
                    data:
                      object:
                        code:
                          text:
                            literal: "user_not_found"
    - title: "Obtain a token as a valid user, but wrong password"
      tags: 
        - shp
        - sphera 
        - rwanda
        - token
      backgrounds:
        - "Sphera SHP api is online"
      steps: 
        - title: "Ask for a token"
          send:
            to: shp_api
            spec:
              object:
                headers:
                  object:
                    content-type: 
                      text:
                        literal: "application/json"
                body:
                  object:
                    cmd:
                      text:
                        literal: "sphera/shp/get_token"
                    data:
                      object:
                        id:
                          text:
                            literal: "doctor1@rwanda.sphera"
                        password:
                          text:
                            literal: "wrong"
                        device:
                          text:
                            literal: "device1"
                        domain_id:
                          text:
                            literal: "sphera/rwanda"
        - title: "Check we got an invalid password error"
          receive:
            from: shp_api       
            spec:
              object:
                status: 200
                body:
                  object:
                    data:
                      object:
                        code:
                          text:
                            literal: "invalid_password"
          
    - title: "Get the last consent as a doctor"
      tags: 
        - shp
        - sphera 
        - rwanda
        - doctor
        - last_consent
      backgrounds:
        - "Sphera SHP api is online"
        - "I am logged in as a doctor"
      steps:
        - title: "Get the last consent"
          send:
            to: shp_api
            spec:
              object:
                headers:
                  object:
                    x-netcomposer-auth:
                      key: token
                      in: data
                    content-type: 
                      text:
                        literal: "application/json"
                body:
                  object:
                    cmd:
                      text:
                        literal: "sphera/shp/get_consent"
        - title: "Check we got an invalid role error"
          receive:
            from: shp_api       
            spec:
              object:
                status: 200
                body:
                  object:
                    data:
                      object:
                        code:
                          text:
                            literal: "invalid_role"
    
    - title: "Get the last consent as an anonymous user"
      tags: 
        - shp
        - sphera 
        - rwanda
        - anonymous
        - consent
      backgrounds:
        - "Sphera SHP api is online"
      steps:
        - title: "Try to get the last consent, without a token"
          send:
            to: shp_api
            spec:
              object:
                headers:
                  object:
                    content-type: 
                      text:
                        literal: "application/json"
                body:
                  object:
                    cmd:
                      text:
                        literal: "sphera/shp/get_consent"
        - title: "Check we got a 403"
          receive:
            from: shp_api       
            spec:
              object:
                status: 403

    - title: "Get the last consent on an empty database"
      tags: 
        - shp
        - sphera 
        - rwanda
        - consent
        - empty
        - error
      backgrounds:
        - "Sphera SHP api is online"
        - "I am logged in as admin"
        - "There are no conversations"
        - "There are no encounters"
        - "There are no patients"
        - "Default channels are present"
        - "There are no objects of type consent"
        - "There are no objects of type operator"
        - "There is an operator"
        - "There are no tokens"
        - "I am logged in as an operator"
        - "Get last consent returns a consent error"
    
    - title: "Get the last consent on a database with one non default, non signed consent"
      tags: 
        - shp
        - sphera 
        - rwanda
        - consent
        - error
      backgrounds:
        - "Sphera SHP api is online"
        - "I am logged in as admin"
        - "There are no conversations"
        - "There are no encounters"
        - "There are no patients"
        - "Default channels are present"
        - "There are no objects of type consent"
        - "There are no objects of type operator"
        - "There is an operator"
        - "There is a consent"
        - "There are no tokens"
        - "I am logged in as an operator"
        - "Get last consent returns a consent error"
    
    - title: "Get the last consent on a database with a default, non signed consent"
      tags: 
        - shp
        - sphera 
        - rwanda
        - consent
        - default
        - unsigned
      backgrounds:
        - "Sphera SHP api is online"
        - "I am logged in as admin"
        - "There are no conversations"
        - "There are no encounters"
        - "There are no patients"
        - "Default channels are present"
        - "There are no objects of type consent"
        - "There are no objects of type operator"
        - "There is an operator"
        - "There is a default consent"
        - "There are no tokens"
        - "I am logged in as an operator"
        - "Get last consent returns the consent data"
      steps:
        - title: "Verify the consent is not signed"
          expect:
            eq:
              - keyword: false
              - key: is_signed
                in: 
                  key: consent
                  in: data

    - title: "Get the last consent on a database with a default, signed consent"
      tags: 
        - shp
        - sphera 
        - rwanda
        - consent
        - default
        - signed
      backgrounds:
        - "Sphera SHP api is online"
        - "I am logged in as admin"
        - "There are no conversations"
        - "There are no encounters"
        - "There are no patients"
        - "Default channels are present"
        - "There are no objects of type consent"
        - "There are no objects of type operator"
        - "There is an operator"
        - "There is a default consent"
        - "There are no tokens"
        - "I am logged in as an operator"
        - "The consent is signed"
        - "Get last consent returns the consent data"
      steps:
        - title: "Verify the consent is not signed"
          expect:
            eq:
              - keyword: true
              - key: is_signed
                in: 
                  key: consent
                  in: data
    
    - title: "Doctor tries to sign a consent"
      tags: 
        - shp
        - sphera 
        - rwanda
        - consent
        - doctor
        - sign
        - forbidden
      backgrounds:
        - "Sphera SHP api is online"
        - "I am logged in as admin"
        - "There are no conversations"
        - "There are no encounters"
        - "There are no patients"
        - "Default channels are present"
        - "There are no objects of type consent"
        - "There are no objects of type operator"
        - "There is an operator"
        - "There is a default consent"
        - "There are no tokens"
        - "I am logged in as a doctor"
      steps:
        - title: "Try to set the consent as signed"
          send:
            to: shp_api
            spec:
              object:
                headers:
                  content-type: "application/json"
                  x-netcomposer-auth:
                    key: token
                    in: data
                body:
                  object:
                    cmd: "sphera/shp/set_consent"
                    data:
                      object:
                        consent_id:
                          key: consent
                          in: data
                        is_signed:
                          keyword: true

        - title: "Check we got an invalid role error"
          receive:
            from: shp_api       
            spec:
              object:
                status: 200
                body:
                  object:
                    result: "error"
                    data:
                      object:
                        code: "invalid_role"

    - title: "Anonymous tries to find patient"
      tags: 
        - shp
        - sphera 
        - rwanda
        - anonymous 
        - patient
        - forbidden
      backgrounds:
        - "Sphera SHP api is online"
        - "I am logged in as admin"
        - "There are no conversations"
        - "There are no encounters"
        - "There are no patients"
        - "Default channels are present"
        - "There is a patient"
        - "There are no tokens"
      steps:
        - title: "Try to find a patient without a token"
          send:
            to: shp_api
            spec:
              object:
                headers:
                  content-type: "application/json"
                body:
                  object:
                    cmd: "sphera/shp/find_patient"
                    data:
                      object:
                        patient_id: "1006"
                        initials: "ABC"

        - title: "Check we got a 403"
          receive:
            from: shp_api       
            spec:
              object:
                status: 403
    
    - title: "Operator is able to find patients"
      tags: 
        - shp
        - sphera 
        - rwanda
        - operator 
        - patient
      backgrounds:
        - "Sphera SHP api is online"
        - "I am logged in as admin"
        - "There are no conversations"
        - "There are no encounters"
        - "There are no patients"
        - "Default channels are present"
        - "There is a patient"
        - "There are no tokens"
        - "I am logged in as an operator"
        - "Get empty data for patient 9000"

    - title: "Doctor is able to find patients"
      tags: 
        - shp
        - sphera 
        - rwanda
        - doctor 
        - patient
        - read
      backgrounds:
        - "Sphera SHP api is online"
        - "I am logged in as admin"
        - "There are no conversations"
        - "There are no encounters"
        - "There are no patients"
        - "Default channels are present"
        - "There is a patient"
        - "There are no tokens"
        - "I am logged in as a doctor"
        - "Get empty data for patient 9000"
    
    - title: "Doctor can modify patient data"
      tags: 
        - shp
        - sphera 
        - rwanda
        - doctor 
        - patient
        - modify
      backgrounds:
        - "Sphera SHP api is online"
        - "I am logged in as admin"
        - "There are no conversations"
        - "There are no encounters"
        - "There are no patients"
        - "Default channels are present"
        - "There is a patient"
        - "There are no tokens"
        - "I am logged in as a doctor"
      steps:
        - title: "Update patient birth date to 01-01-2001"
          send:
            to: shp_api
            spec:
              object:
                headers:
                  content-type: "application/json"
                  x-netcomposer-auth:
                    key: token
                    in: data
                body:
                  object:
                    cmd: "sphera/shp/set_patient_data"
                    data:
                      object:
                        patient_id: 9000
                        data:
                          object:
                            type: "sphera_shp_1"
                            data:
                              object:
                                birth: "01-01-2001"
          
        - title: "Get data for patient 9000"
          send:
            to: shp_api
            spec:
              object:
                headers:
                  content-type: "application/json"
                  x-netcomposer-auth:
                    key: token
                    in: data
                body:
                  object:
                    cmd: "sphera/shp/find_patient"
                    data:
                      object:
                        patient_id: "9000"
                        initials: "ABC"

        - title: "Verify the birth date is equal to 01-01-2001"
          receive:
            from: shp_api
            spec:
              object:
                status: 200
                body:
                  object:
                    data:
                      object:
                        data:
                          list:
                            - object:
                                date:
                                  any: number
                                data:
                                  object:
                                    type: "sphera_shp_1"
                                    data:
                                      object:
                                        birth: "01-01-2001"

    - title: "Anonymous user attempts to modify patient data"
      tags: 
        - shp
        - sphera 
        - rwanda
        - doctor 
        - anonymous
        - modify
      backgrounds:
        - "Sphera SHP api is online"
        - "I am logged in as admin"
        - "There are no conversations"
        - "There are no encounters"
        - "There are no patients"
        - "Default channels are present"
        - "There is a patient"
        - "There are no tokens"
      steps:
        - title: "As a anonymous user, try to update patient birth date to 01-01-2001"
          send:
            to: shp_api
            spec:
              object:
                headers:
                  content-type: "application/json"
                body:
                  object:
                    cmd: "sphera/shp/set_patient_data"
                    data:
                      object:
                        patient_id: 9000
                        data:
                          object:
                            type: "sphera_shp_1"
                            data:
                              object:
                                birth: "01-01-2001"
        
        - title: "Check we got a 403"
          receive:
            from: shp_api       
            spec:
              object:
                status: 403
    
    - title: "Doctor tries to create an encounter for a patient"
      tags: 
        - shp
        - sphera 
        - rwanda
        - doctor 
        - encounter
      backgrounds:
        - "Sphera SHP api is online"
        - "I am logged in as admin"
        - "There are no conversations"
        - "There are no encounters"
        - "There are no patients"
        - "Default channels are present"
        - "There is a patient"
        - "There are no tokens"
        - "I am logged in as a doctor"
      steps:
        - title: "Create an encounter for patient 9000 in pediatrics"
          send:
            to: shp_api
            spec:
              object:
                headers:
                  content-type: "application/json"
                  x-netcomposer-auth:
                    key: token
                    in: data
                body:
                  object:
                    cmd: "sphera/shp/create_encounter"
                    data:
                      object:
                        patient_id: "9000"
                        speciality:  "/sphera/brazil/collab/med.specialities/pediatrics"
                        patient_info:
                          object:
                            type: "sphera_shp_1"
                            data:
                              object:
                                medical_questionary:
                                  object:
                                    data: "a value"
                            text: "some text"

        - title: "Verify I got an invalid role error"
          receive:
            from: shp_api
            spec:
              object:
                status: 200
                body:
                  object:
                    result: "error"
                    data:
                      object:
                        code: "role_invalid"
    
    - title: "Doctor tries to create an encounter, using the collab api"
      tags: 
        - shp
        - sphera 
        - rwanda
        - doctor 
        - encounter
        - current
      backgrounds:
        - "Sphera SHP api is online"
        - "I am logged in as admin"
        - "There are no conversations"
        - "There are no encounters"
        - "There are no patients"
        - "Default channels are present"
        - "There is a patient"
        - "There are no tokens"
        - "A collab connection for a doctor"
        - "I am logged in as a doctor on the collab"
        - "I have a chat session"
        - "I turn on chat notifications"
        - "I try to create an encounter using the collab"
        - "Expect an invalid role error"
    
    - title: "Anonymous user tries to create an encounter for a patient"
      tags: 
        - shp
        - sphera 
        - rwanda
        - anonymous 
        - encounter
      backgrounds:
        - "Sphera SHP api is online"
        - "I am logged in as admin"
        - "There are no conversations"
        - "There are no encounters"
        - "There are no patients"
        - "Default channels are present"
        - "There is a patient"
        - "There are no tokens"
      steps:
        - title: "As an anonymous user, try to create an encounter for patient 9000 in pediatrics"
          send:
            to: shp_api
            spec:
              object:
                headers:
                  content-type: "application/json"
                body:
                  object:
                    cmd: "sphera/shp/create_encounter"
                    data:
                      object:
                        patient_id: "9000"
                        speciality:  "/sphera/brazil/collab/med.specialities/pediatrics"
                        patient_info:
                          object:
                            type: "sphera_shp_1"
                            data:
                              object:
                                medical_questionary:
                                  object:
                                    data: "a value"
                            text: "some text"

        - title: "Verify I got a 403"
          receive:
            from: shp_api
            spec:
              object:
                status: 403
    
    - title: "Operator creates an encounter for a patient"
      tags: 
        - shp
        - sphera 
        - rwanda
        - operator 
        - encounter
      backgrounds:
        - "Sphera SHP api is online"
        - "I am logged in as admin"
        - "There are no conversations"
        - "There are no encounters"
        - "There are no patients"
        - "Default channels are present"
        - "There is a patient"
        - "There are no tokens"
        - "I am logged in as an operator"
        - "A new encounter"
    
    - title: "Anonymous user tries to obtain a report"
      tags: 
        - shp
        - sphera 
        - rwanda
        - anonymous
        - reports
      backgrounds:
        - "Sphera SHP api is online"
        - "I am logged in as admin"
        - "There are no conversations"
        - "There are no encounters"
        - "There are no patients"
        - "Default channels are present"
        - "There is a patient"
        - "There are no tokens"
        - "I am logged in as an operator"
        - "A new encounter"
      steps:
        - title: "As an anonymous user, try to obtain a report"
          send:
            to: shp_api
            spec:
              object:
                headers:
                  content-type: "application/json"
                body:
                  object:
                    cmd: "sphera/shp/find_reports"

        - title: "Verify I got a 403"
          receive:
            from: shp_api
            spec:
              object:
                status: 403

    
    - title: "Operator is able to upload medical data for an encounter"
      tags: 
        - shp
        - sphera 
        - rwanda
        - operator 
        - medical_data 
      backgrounds:
        - "Sphera SHP api is online"
        - "I am logged in as admin"
        - "There are no conversations"
        - "There are no encounters"
        - "There are no patients"
        - "Default channels are present"
        - "There is a patient"
        - "There are no tokens"
        - "I am logged in as an operator"
        - "A new encounter"
        - "Medical data uploaded for that encounter"
    
    - title: "Doctor is able to upload medical data for an encounter"
      tags: 
        - shp
        - sphera 
        - rwanda
        - operator 
        - medical_data 
      backgrounds:
        - "Sphera SHP api is online"
        - "I am logged in as admin"
        - "There are no conversations"
        - "There are no encounters"
        - "There are no patients"
        - "Default channels are present"
        - "There is a patient"
        - "There are no tokens"
        - "I am logged in as an operator"
        - "A new encounter"
        - "I am logged in as a doctor"
        - "Medical data uploaded for that encounter"
    
    - title: "Both doctor and operator areable to upload medical data on the same encounter"
      tags: 
        - shp
        - sphera 
        - rwanda
        - operator
        - doctor
        - medical_data 
      backgrounds:
        - "Sphera SHP api is online"
        - "I am logged in as admin"
        - "There are no conversations"
        - "There are no encounters"
        - "There are no patients"
        - "Default channels are present"
        - "There is a patient"
        - "There are no tokens"
        - "I am logged in as an operator"
        - "A new encounter"
        - "I am logged in as a doctor"
        - "Medical data uploaded for that encounter"
        - "I am logged in as an operator"
        - "Medical data uploaded for that encounter"
    
    - title: "Anonymous user tries to upload medical data to an encounter"
      tags: 
        - shp
        - sphera 
        - rwanda
        - anonymous
        - upload
        - medical_data 
      backgrounds:
        - "Sphera SHP api is online"
        - "I am logged in as admin"
        - "There are no conversations"
        - "There are no encounters"
        - "There are no patients"
        - "Default channels are present"
        - "There is a patient"
        - "There are no tokens"
        - "I am logged in as an operator"
        - "A new encounter"
      steps:
        - title: "As an anonymous user, try to upload medical data with a equal to 1"
          send:
            to: shp_api
            spec:
              object:
                headers:
                  content-type: "application/json"
                body:
                  object:
                    cmd: "sphera/shp/upload_medical_data"
                    data:
                      object:
                        encounter_id:
                          key: encounter_id
                          in: data
                        data:
                          object:
                            a: 1

        - title: "Verify I got an 403"
          receive:
            from: shp_api
            spec:
              object:
                status: 403
    
    - title: "Operator is able to check whether a doctor is online or not, for a given encounter"
      tags: 
        - shp
        - sphera 
        - rwanda
        - operator 
        - doctor_online
      backgrounds:
        - "Sphera SHP api is online"
        - "I am logged in as admin"
        - "There are no conversations"
        - "There are no encounters"
        - "There are no patients"
        - "Default channels are present"
        - "There is a patient"
        - "There are no tokens"
        - "I am logged in as an operator"
        - "A new encounter"
      steps:
        - title: "Check whether doctor is online for the encounter"
          send:
            to: shp_api
            spec:
              object:
                headers:
                  x-netcomposer-auth:
                    key: token
                    in: data
                  content-type: "application/json"
                body:
                  object:
                    cmd: "sphera/shp/is_doctor_online"
                    data:
                      object:
                        encounter_id:
                          key: encounter_id
                          in: data
        - title: "Verify the doctor is offline"
          receive:
            from: shp_api
            spec:
              object:
                status: 200
                body:
                  object:
                    result: "ok"
                    data:
                      object:
                        status: "new"
                        doctor_is_online: 
                          keyword: false

    - title: "Anonymous is not able to check doctor presence status"
      tags: 
        - shp
        - sphera 
        - rwanda
        - operator 
        - doctor_online
      backgrounds:
        - "Sphera SHP api is online"
        - "I am logged in as admin"
        - "There are no conversations"
        - "There are no encounters"
        - "There are no patients"
        - "Default channels are present"
        - "There is a patient"
        - "There are no tokens"
        - "I am logged in as an operator"
        - "A new encounter"
      steps:
        - title: "As an anonymous user, check whether doctor is online for the encounter"
          send:
            to: shp_api
            spec:
              object:
                headers:
                  content-type: "application/json"
                body:
                  object:
                    cmd: "sphera/shp/is_doctor_online"
                    data:
                      object:
                        encounter_id:
                          key: encounter_id
                          in: data
        - title: "Verify we got a 403"
          receive:
            from: shp_api
            spec:
              object:
                status: 403
    
    - title: "Attach files to an encounter"
      tags: 
        - shp
        - sphera 
        - rwanda
        - operator 
        - attach
      backgrounds:
        - "Sphera SHP api is online"
        - "I am logged in as admin"
        - "There are no conversations"
        - "There are no encounters"
        - "There are no patients"
        - "Default channels are present"
        - "There is a patient"
        - "There are no tokens"
        - "I am logged in as an operator"
        - "A new encounter"
        - "That encounter file upload api for name file.txt"
      steps:
        - title: "Upload a file to that encounter"
          send:
            to: encounter_file_api
            spec:
              object:
                headers:
                  x-netcomposer-auth:
                    key: token
                    in: data
                  content-type: "text/plain"
                body: "abc"

        - title: "Verify I got a 200 ok"
          receive:
            from: encounter_file_api
            spec:
              object:
                status: 200

        - title: "As an anonymous user, try to upload a file to that encounter"
          send:
            to: encounter_file_api
            spec:
              object:
                headers:
                  content-type: "text/plain"
                body: "abc"

        - title: "Verify I got a 400"
          receive:
            from: encounter_file_api
            spec:
              object:
                status: 400
                body:
                  object:
                    data:
                      object:
                        code: "token_invalid"
    - title: "Doctor can resolve encounter"
      tags: 
        - collab
        - sphera 
        - rwanda
        - doctor
        - reports
      backgrounds:
        - "Sphera SHP api is online"
        - "I am logged in as admin"
        - "There are no conversations"
        - "There are no encounters"
        - "There are no patients"
        - "There are no messages"
        - "Default channels are present"
        - "There is a patient"
        - "I am logged in as an operator"
        - "A new encounter"
        - "There are no tokens"
        - "A collab connection for a doctor"
        - "I am logged in as a doctor on the collab"
        - "I have a chat session"
        - "I turn on chat notifications"
        - "Assign that encounter to me"
        - "Expect an assigned encounter"
        - "I added a new report to the encounter"
        - "Expect a resolved encounter"
        - "I am logged in as an operator"
        - "There is a report for that encounter"

    - title: "Doctor can confirm encounter"
      tags: 
        - collab
        - sphera 
        - rwanda
        - doctor
      backgrounds:
        - "Sphera SHP api is online"
        - "I am logged in as admin"
        - "There are no conversations"
        - "There are no encounters"
        - "There are no patients"
        - "There are no messages"
        - "Default channels are present"
        - "There is a patient"
        - "I am logged in as an operator"
        - "A new encounter"
        - "There are no tokens"
        - "A collab connection for a doctor"
        - "I am logged in as a doctor on the collab"
        - "I have a chat session"
        - "I turn on chat notifications"
        - "Assign that encounter to me"
        - "Expect an assigned encounter"
        - "I confirmed the encounter"
        - "Expect a resolved encounter"
