version: 1.0
type: test 
name: cmtest 
spec:
  config:
    retries: 100
    wait: 5
  backgrounds: 
    - title: "Admin api is online"
      steps:
        - title: "Connect to the Admin api"
          connect:
            app: admin_api
            port: admin
            transport: ws
        - title: "Check the Admin api is ready"
          probe:
            app: admin_api
            status: up
    - title: "Admin database is empty"
      steps:
        - title: "Send a reset command to Admin" 
          send:
            to: admin_api
            spec:
              object:
                action:
                  text:
                    literal: "reset"
                token:
                  text:
                    literal: "87fb5ce6-d847-494b-ac35-a1a37186c276"
        - title: "Verify status is ok"
          receive:
            from: admin_api
            spec:
              object:
                status:
                  text:
                    literal: "ok"
    - title: "Admin user John"
      steps:
        - title: "Register as John"
          send:
            to: admin_api
            spec:
              object:
                action: 
                  text:
                    literal: register
                first: 
                  text:
                    literal: John
                last: 
                  text:
                    literal: Chrichton
                username: 
                  text:
                    literal: john@farscape.com
                password: 
                  text:
                    literal: foo
                password_confirm: 
                  text:
                    literal: foo
        - title: "Verify we got a user id and email" 
          receive:
            from: admin_api
            spec:
              object:
                id:
                  any: text
                email:
                  any: text
    - title: "John logged in"
      steps:
        - title: "Log in as John"
          send:
            to: admin_api
            spec:
              object:
                action: 
                  text: 
                    literal: login
                username: 
                  text: 
                    literal: john@farscape.com
                password: 
                  text:
                    literal: foo
        - title: "Verify we got a user id and email"
          receive:
            from: admin_api
            spec:
              object:
                id:
                  any: text
                email:
                  any: text
  scenarios:
    - title: "Get all tests"
      purpose: "Verify that the admin user is able to retrieve all tests"
      tags: admin, tests
      backgrounds:
        - "Admin api is online"
        - "Admin database is empty"
        - "Admin user John"
        - "John logged in"
      steps:
        - title: "Get all tests"
          send:
            to: admin_api
            spec:
              object:
                action: 
                  text: 
                    literal: tests
        - title: "Verify we got at least one test"
          receive:
            from: admin_api
            spec:
              object:
                tests:
                  list:
                    object:
                      name:
                        any: text
                      backgrounds:
                        any: number
                      scenarios:
                        any: number

                          
    - title: "Get a single test info"
      purpose: "Verify that the admin user is able to retrieve info about a test"
      tags: admin, tests
      backgrounds:
        - "Admin api is online"
        - "Admin database is empty"
        - "Admin user John"
        - "John logged in"
      steps:
        - title: "Get this test info"
          send:
            to: admin_api
            spec:
              object:
                action: 
                  text: 
                    literal: "test"
                test:
                  text:
                    literal: "cmtest"
        - title: "Verify we got the test info"
          receive:
            from: admin_api
            spec:
              object:
                test:
                  object:
                    name:
                      text: 
                        literal: "cmtest"
                    backgrounds:
                      any: list
                    scenarios:
                      any: list
    
    - title: "Attempt to find a scenario that does not exist"
      purpose: "Verify that the tests api returns proper errors"
      tags: admin, tests
      backgrounds:
        - "Admin api is online"
        - "Admin database is empty"
        - "Admin user John"
        - "John logged in"
      steps:
        - title: "Get some unknown scenario info"
          send:
            to: admin_api
            spec:
              object:
                action: 
                  text: 
                    literal: "scenario"
                test:
                  text:
                    literal: "cmtest"
                scenario:
                  text:
                    literal: "Some scenario that should not exist"
        - title: "Verify we got a proper not found error"
          receive:
            from: admin_api
            spec:
              object:
                scenario:
                  object:
                    test:
                      text: 
                        literal: "cmtest"
                    title:
                      text: 
                        literal: "Some scenario that should not exist"
                    error:
                      text:
                        literal: "not_found"

    - title: "Get a single scenario info"
      purpose: "Verify that the admin user is able to retrieve info about a scenario"
      tags: admin, tests
      backgrounds:
        - "Admin api is online"
        - "Admin database is empty"
        - "Admin user John"
        - "John logged in"
      steps:
        - title: "Get this scenario info info"
          send:
            to: admin_api
            spec:
              object:
                action: 
                  text: 
                    literal: "scenario"
                test:
                  text:
                    literal: "cmtest"
                scenario:
                  text:
                    literal: "Get a single scenario info"
        - title: "Verify we got the scenario info"
          receive:
            from: admin_api
            spec:
              object:
                scenario:
                  object:
                    test:
                      text: 
                        literal: "cmtest"
                    title:
                      text: 
                        literal: "Get a single scenario info"
                    tags:
                      any: list
                    backgrounds:
                      any: list
                    steps:
                      any: list
                    purpose:
                      any: text
    
    - title: "Get a single background info"
      purpose: "Verify that the admin user is able to retrieve info about a background"
      tags: admin, tests, backgrounds
      backgrounds:
        - "Admin api is online"
        - "Admin database is empty"
        - "Admin user John"
        - "John logged in"
      steps:
        - title: "Get info for background with title 'John logged in'"
          send:
            to: admin_api
            spec:
              object:
                action: 
                  text: 
                    literal: "background"
                test:
                  text:
                    literal: "cmtest"
                background:
                  text:
                    literal: "John logged in"
        - title: "Verify we got the info for that background"
          receive:
            from: admin_api
            spec:
              object:
                background:
                  object:
                    test:
                      text: 
                        literal: "cmtest"
                    title:
                      text: 
                        literal: "John logged in"
                    scenarios:
                      any: list
                    steps:
                      any: list
                    tags:
                      any: list
