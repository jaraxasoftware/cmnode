version: 1.0
type: test 
name: weekonekt
spec:
  config:
    retries: 100
    wait: 5
  backgrounds:
    - title: "Weekonekt admin api is online"
      steps:
        - title: "connect to weekonekt admin api"
          connect:
            app: weekonekt_admin_api
            port: weekonekt_admin
            transport: ws
        - title: "check weekonekt admin api is ready"
          probe:
            app: weekonekt_admin_api
            status: up
    - title: "Weekonekt files api is online"
      steps:
        - title: "Connect to weekonekt files api"
          connect:
            app: weekonekt_file_api
            port: weekonekt_admin
            transport: http
        - title: "Verify weekonekt files api is ready"
          probe:
            app: weekonekt_file_api
            status: up
    - title: "Weekonekt admin database is empty"
      steps:
        - title: "Send a reset command to weekonekt admin" 
          send:
            to: weekonekt_admin_api
            spec:
              object:
                action:
                  text:
                    literal: "reset"
                token:
                  text:
                    literal: "87fb5ce6-d847-494b-ac35-a1a37186c276"
        - title: "Verify status is ok"
          receive:
            from: weekonekt_admin_api
            spec:
              object:
                status:
                  text:
                    literal: "ok"
    - title: "Admin user Marcos"
      steps:
        - title: "Register as Marcos"
          send:
            to: weekonekt_admin_api
            spec:
              object:
                action: 
                  text:
                    literal: register
                first: 
                  text:
                    literal: Marcos
                last: 
                  text:
                    literal: Chrichton
                username: 
                  text:
                    literal: marcos@farscape.com
                password: 
                  text:
                    literal: foo
                password_confirm: 
                  text:
                    literal: foo
        - title: "Verify we got a user id and email" 
          receive:
            from: weekonekt_admin_api
            spec:
              object:
                id:
                  any: text
                email:
                  any: text
    - title: "Marcos logged in"
      steps:
        - title: "Log in as Marcos"
          send:
            to: weekonekt_admin_api
            spec:
              object:
                action: 
                  text: 
                    literal: login
                username: 
                  text: 
                    literal: marcos@farscape.com
                password: 
                  text:
                    literal: foo
        - title: "Verify we got a user id and email"
          receive:
            from: weekonekt_admin_api
            spec:
              object:
                id:
                  any: text
                email:
                  any: text
    - title: "A weekonekt import"
      steps:
        - title: "Create an import"
          send:
            to: weekonekt_admin_api
            spec:
              object:
                action:
                  text:
                    literal: create_import 
        - title: "Verify we got a created event"
          receive:
            from: weekonekt_admin_api
            spec:
              object:
                import:
                  object:
                    id:
                      any: text
                    status:
                      text:
                        literal: "created"
                    date:
                      any: number
            as: import 
    - title: "An import token" 
      steps:
        - title: "Create a new token for that import"
          send:
            to: weekonekt_admin_api
            spec:
              object:
                action:
                  text:
                    literal: token
                subject:
                  key: id
                  in:
                    key: import
                    in:
                      key: import
                      in: data
                intent:
                  keyword: attach
                type:
                  keyword: import

        - title: "Verify we got a token"
          receive:
            from: weekonekt_admin_api
            spec:
              object:
                token: 
                  any: text
    - title: "Invalid wordpress file uploaded" 
      steps:
        - title: "Upload an invalid file"
          send:
            to: weekonekt_file_api
            spec:
              request:
                method: post
                headers:
                  content_type:
                    text:
                      literal: "application/xml"
                  cmauth:
                    key: token
                    in:
                      key: latest
                      in: data
                body:
                  file: 
                    at: "/Users/pedrogutierrez/Documents/dummy.xml"
        - title: "Verify the file was uploaded"
          receive:
            from: weekonekt_file_api
            spec:
              object:
                id:
                  text: any
                size:
                  number: any
                type:
                  text: 
                    literal: "application/xml"
                created:
                  number: any
            as: wordpress
    - title: "Small wordpress file uploaded" 
      steps:
        - title: "Upload an sample wordpress file"
          send:
            to: weekonekt_file_api
            spec:
              request:
                method: post
                headers:
                  content_type:
                    text:
                      literal: "application/xml"
                  cmauth:
                    key: token
                    in:
                      key: latest
                      in: data
                body:
                  file: 
                    at: "/Users/pedrogutierrez/Documents/wordpress.xml"
        - title: "Verify the file was uploaded"
          receive:
            from: weekonekt_file_api
            spec:
              object:
                id:
                  text: any
                size:
                  number: any
                type:
                  text: 
                    literal: "application/xml"
                created:
                  number: any
            as: wordpress
    - title: "File attached to import" 
      steps:
        - title: "Attach that file to the import"
          send:
            to: weekonekt_admin_api
            spec:
              object:
                action:
                  text:
                    literal: attach
                import:
                  key: id
                  in:
                    key: import
                    in:
                      key: import
                      in: data
                file:
                  key: id
                  in:
                    key: wordpress
                    in: data
        - title: "Verify the import was started"
          receive:
            from: weekonekt_admin_api
            spec:
              object:
                import:
                  object:
                    id: 
                      any: text
                    status:
                      text:
                        literal: "started"
                    date:
                      any: number
  scenarios:
    - title: "List imports"
      tags: weekonekt, import 
      backgrounds:
        - "Weekonekt admin api is online"
        - "Weekonekt files api is online"
        - "Weekonekt admin database is empty"
        - "Admin user Marcos"
        - "Marcos logged in"
      steps:
        - title: "Fetch imports"
          send:
            to: weekonekt_admin_api
            spec:
              object:
                action:
                  text:
                    literal: imports
        - title: "Verify we got an empty list of imports"
          receive:
            from: weekonekt_admin_api
            spec:
              object:
                imports:
                  list: empty

    - title: "Invalid wordpress import"
      purpose: "Verify that the weekonekt admin is able to create a new import"
      tags: weekonekt, import, upload
      backgrounds:
        - "Weekonekt admin api is online"
        - "Weekonekt files api is online"
        - "Weekonekt admin database is empty"
        - "Admin user Marcos"
        - "Marcos logged in"
        - "A weekonekt import"
        - "An import token"
        - "Invalid wordpress file uploaded"
        - "File attached to import"
      steps:
        - title: "Verify the import was finished"
          receive:
            from: weekonekt_admin_api
            spec:
              object:
                import:
                  object:
                    id: 
                      any: text
                    status:
                      text:
                        literal: "finished"
                    date:
                      any: number
        - title: "Verify we got nothing imported"
          receive:
            from: weekonekt_admin_api
            spec:
              object:
                import:
                  object:
                    id: 
                      any: text
                    images:
                      number: 0
                    reviews:
                      number: 0

    - title: "Small wordpress import"
      purpose: "Verify that the weekonekt admin is able to import small files"
      tags: weekonekt, import, upload, sample_import
      backgrounds:
        - "Weekonekt admin api is online"
        - "Weekonekt files api is online"
        - "Weekonekt admin database is empty"
        - "Admin user Marcos"
        - "Marcos logged in"
        - "A weekonekt import"
        - "An import token"
        - "Small wordpress file uploaded"
        - "File attached to import"
      steps:
        - title: "Verify the import was finished"
          receive:
            from: weekonekt_admin_api
            spec:
              object:
                import:
                  object:
                    id: 
                      any: text
                    status:
                      text:
                        literal: "finished"
                    date:
                      any: number
        - title: "Verify we got something imported"
          receive:
            from: weekonekt_admin_api
            spec:
              object:
                import:
                  object:
                    id: 
                      any: text
                    images:
                      number: 648
                    reviews:
                      number: 51
